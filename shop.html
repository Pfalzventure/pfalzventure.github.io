<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shop – Pfalzventure</title>
  <link rel="stylesheet" href="style.css">

  <!-- PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=AQbF-v1VWk6QCLKdNODfXJb-fUAcoTsnE1ux9JvHUWNYuJQE1xskgSu7ff_qniWdL168KWEw_oX7iCHB&currency=EUR"></script>
</head>
<body>
  <!-- Header wird dynamisch geladen -->
  <div id="header-placeholder"></div>

  <!-- ============================
       Shop-Bereich
       ============================ -->
  <main class="shop-section">
    <h1>Shop</h1>

    <!-- Produkt 1 -->
    <div class="product">
      <h2>Survival Kit</h2>
      <p>Alles, was du für dein Abenteuer brauchst.</p>
      <button class="btn add-btn" onclick="addToCart('Survival Kit', 49.00)">In den Warenkorb (49 €)</button>
    </div>

    <!-- Produkt 2: Kurs-Gutschein -->
    <div class="product">
      <h2>Kurs-Gutschein</h2>
      <p>Verschenke ein unvergessliches Erlebnis. <br>Wähle einen für dich passenden Termin:</p>

      <label for="kursTermine">Mögliche Termine:</label><br>
      <select id="kursTermine" multiple size="4" style="width:100%; max-width:320px;"></select>
      <br><br>
      <button class="btn add-btn" onclick="addCourseVoucher()">In den Warenkorb (1 €)</button>
    </div>

    <!-- Produkt 3 -->
    <div class="product">
      <h2>Wert-Gutschein</h2>
      <p>Wähle selbst, wie viel dir das Abenteuer wert ist.</p>
      <label for="voucherAmount">Betrag in €:</label>
      <input type="number" id="voucherAmount" value="50" min="10" step="5">
      <button class="btn add-btn" onclick="addVoucher()">In den Warenkorb</button>
    </div>
  </main>

  <!-- ============================
       Footer
       ============================ -->
  <footer>
    <p>© 2025 Pfalzventure – Robert Prokasky</p>
    <p><a href="impressum.html">Impressum</a> | <a href="datenschutz.html">Datenschutz</a></p>
  </footer>

  <!-- ============================
       Header laden + Shop-Logik
       ============================ -->
  <script>
    // Header laden
    fetch("header.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("header-placeholder").innerHTML = data;
        initShopScripts(); // nach Header laden starten wir die Shop-Logik
      });

    function initShopScripts() {
      let cart = [];

      // Kurstermine laden
      fetch("assets/kurstermine.json")
        .then(res => res.json())
        .then(data => {
          let select = document.getElementById("kursTermine");
          data.termine.forEach(t => {
            let opt = document.createElement("option");
            opt.value = t.id;
            opt.textContent = t.text;
            select.appendChild(opt);
          });
        });

      // Produkt hinzufügen
      window.addToCart = function(name, price) {
        let existing = cart.find(item => item.name === name && item.price === price);
        if (existing) {
          existing.qty += 1;
        } else {
          cart.push({ name, price, qty: 1 });
        }
        saveCart();
      };

      // Kurs-Gutschein
      window.addCourseVoucher = function() {
        let select = document.getElementById("kursTermine");
        let selected = Array.from(select.selectedOptions).map(opt => opt.textContent);

        if (selected.length === 0) {
          alert("Bitte wähle einen Termin aus!");
          return;
        }

        cart.push({
          name: "Kurs-Gutschein",
          price: 1.00,
          qty: 1,
          termine: selected
        });
        saveCart();
      };

      // Wert-Gutschein
      window.addVoucher = function() {
        let amount = parseFloat(document.getElementById("voucherAmount").value);
        if (amount < 10) amount = 10;
        cart.push({ name: "Wert-Gutschein", price: amount, qty: 1 });
        saveCart();
      };

      // Menge ändern
      function increaseQty(i) { cart[i].qty++; saveCart(); }
      function decreaseQty(i) {
        cart[i].qty--;
        if (cart[i].qty <= 0) cart.splice(i, 1);
        saveCart();
      }

      // Gesamt
      function getCartTotal() {
        return cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
      }

      // Cart speichern/laden
      function saveCart() {
        localStorage.setItem("cart", JSON.stringify(cart));
        updateCart();
      }
      function loadCart() {
        let stored = localStorage.getItem("cart");
        if (stored) cart = JSON.parse(stored);
        updateCart();
      }

      // Cart anzeigen
      function updateCart() {
        document.getElementById("cart-count").innerText =
          cart.reduce((sum, item) => sum + item.qty, 0);

        let itemsList = document.getElementById("cart-items");
        itemsList.innerHTML = "";

        cart.forEach((item, i) => {
          let li = document.createElement("li");
          li.classList.add("cart-item");

          let span = document.createElement("span");
          span.innerText = `${item.name} – ${item.price.toFixed(2)} €`;
          if (item.termine) {
            span.innerText += `\n(Termine: ${item.termine.join(", ")})`;
          }

          let controls = document.createElement("div");
          controls.classList.add("cart-controls");

          let minusBtn = document.createElement("button");
          minusBtn.innerText = "➖";
          minusBtn.onclick = () => decreaseQty(i);

          let qtySpan = document.createElement("span");
          qtySpan.innerText = item.qty;
          qtySpan.classList.add("cart-qty");

          let plusBtn = document.createElement("button");
          plusBtn.innerText = "➕";
          plusBtn.onclick = () => increaseQty(i);

          controls.appendChild(minusBtn);
          controls.appendChild(qtySpan);
          controls.appendChild(plusBtn);

          li.appendChild(span);
          li.appendChild(controls);
          itemsList.appendChild(li);
        });

        document.getElementById("cart-total").innerText =
          getCartTotal().toFixed(2);
      }

      // Cart anzeigen/verbergen
      window.toggleCart = function() {
        let cartDiv = document.getElementById("cart");
        cartDiv.style.display = (cartDiv.style.display === "none") ? "block" : "none";
      };

      // PayPal
      paypal.Buttons({
        createOrder: function(data, actions) {
          return actions.order.create({
            purchase_units: [{
              description: cart.map(item => {
                let desc = `${item.name} x${item.qty}`;
                if (item.termine) desc += ` [${item.termine.join(", ")}]`;
                return desc;
              }).join("; "),
              amount: {
                currency_code: "EUR",
                value: getCartTotal().toFixed(2)
              }
            }]
          });
        },
        onApprove: function(data, actions) {
          return actions.order.capture().then(function(details) {
            alert("Vielen Dank! " + details.payer.name.given_name +
              " Deine Bestellung wurde erfolgreich abgeschlossen.");
            cart = [];
            saveCart();
            toggleCart();
          });
        }
      }).render('#paypal-button-container');

      // Start
      loadCart();
    }
  </script>
</body>
</html>

