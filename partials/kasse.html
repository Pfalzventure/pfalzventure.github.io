<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kasse ‚Äî Survival Kurse & Kits</title>

  <style>
    body { font-family: system-ui, sans-serif; padding: 1rem; color:#222; }
    .container { max-width:900px; margin:0 auto; display:grid; grid-template-columns: 1fr 360px; gap:1.5rem; }
    h1, h2, h3 { color: var(--dark-green, #0f5132); }
    .card { background:#fff; border:1px solid #eee; padding:1rem; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.03); }
    .muted { color:#666; font-size:0.95rem; }
    .btn { display:inline-block; padding:0.6rem 1rem; border-radius:6px; border:none; background:#0f5132; color:#fff; cursor:pointer; }
    .btn:disabled { opacity:0.5; cursor:not-allowed; }
    .cart-list { list-style:none; padding:0; margin:0 0 1rem 0; }
    .cart-list li { padding:0.4rem 0; border-bottom:1px dashed #eee; display:flex; justify-content:space-between; align-items:center; }
    .small { font-size:0.9rem; }
    .success { color:green; }
    .error { color:red; }
    label { display:block; margin-top:0.75rem; font-weight:600; }
    input[type="text"], input[type="email"], input[type="tel"], input[type="date"], select { width:100%; padding:0.5rem; margin-top:0.25rem; border:1px solid #ddd; border-radius:6px; }
    .form-actions { margin-top:1rem; display:flex; gap:.5rem; align-items:center; }
    .hidden { display:none !important; }
    .subform { margin:1rem 0; padding:1rem; background:#f8f8f8; border-radius:6px; border:1px solid #e0e0e0; }
    @media (max-width:900px) { 
      .container { grid-template-columns: 1fr; }
      #checkout-right { order:1 !important; }
      #checkout-left { order:2 !important; }
    }
  </style>
</head>
<body>
  <main class="container">

    <!-- Rechte Seite: Warenkorb -->
    <aside class="card" id="checkout-right" style="order:2;">
      <h2>Dein Warenkorb</h2>
      <ul id="cart-items" class="cart-list"></ul>
      <p><strong>Gesamt: <span id="cart-total">0.00</span> ‚Ç¨</strong></p>

      <div id="pay-area" style="margin-top:1rem;">
        <div id="paypal-button-container"></div>
        <div id="paypal-missing" class="hidden small error" style="margin-top:.5rem;">
          PayPal-Script wird ben√∂tigt.
        </div>
          <div id="voucher-section" style="margin-top:1rem;">
        <h3>üéüÔ∏è Gutscheincode einl√∂sen</h3>
        <label for="voucherCode">Gutscheincode</label>
        <input type="text" id="voucherCode" placeholder="Code eingeben">

        <label for="customerEmail">Deine E-Mail-Adresse</label>
        <input type="email" id="customerEmail" placeholder="name@example.com">

        <div class="form-actions">
          <button onclick="submitVoucherRequest()" class="btn" id="voucherBtn">Einl√∂sen</button>
          <span id="voucherMessage" class="small"></span>
        </div>
            </div>
      </div>
    </aside>

    <!-- Linke Seite: Gutschein + Formular -->
    <section class="card" id="checkout-left" style="order:1;">
      <h1>Kasse</h1>
      <p class="muted">Bitte √ºberpr√ºfe deine Bestellung und f√ºlle das Formular aus, wenn du einen Kurs gebucht hast.</p>

          <hr style="margin:1rem 0;">

      <form id="registrationForm" class="hidden" onsubmit="event.preventDefault(); handleFormSubmit();">
        <h2>Teilnehmer 1 (Vertragspartner)</h2>

        <input type="text" name="vorname" id="vorname" placeholder="Vorname" required>
        <input type="text" name="nachname" id="nachname" placeholder="Nachname" required>

        <input type="text" name="strasse" id="strasse" placeholder="Stra√üe & Hausnummer" required>
        <input type="text" name="plz_ort" id="plz_ort" placeholder="PLZ & Ort" required>

        <input type="email" name="email" id="teilnehmer_email" placeholder="E-Mail-Adresse" required>
        <input type="tel" name="telefon" id="telefon" placeholder="Telefonnummer (optional)">

        <label style="font-weight:bold; margin-top:1rem;">Geburtsdatum *</label>
        <input type="date" name="geburtsdatum" id="geburtsdatum" required>

        <label style="margin-top:1.5rem;">Anzahl weiterer Teilnehmer</label>
        <select id="anzahlTeilnehmer">
          <option value="0">Keine</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>

        <div id="zusatzTeilnehmerContainer"></div>

        <h2>Best√§tigungen</h2>

        <label><input type="checkbox" id="agb" required> Ich habe die AGB gelesen und akzeptiere sie stellvertretend f√ºr alle Teilnehmer.</label>
        <label><input type="checkbox" id="fitness" required> Ich best√§tige stellvertretend f√ºr alle Teilnehmer die k√∂rperliche und mentale Eignung.</label>
        <label><input type="checkbox" id="haftung" required> Ich best√§tige den Haftungsausschluss stellvertretend f√ºr alle Teilnehmer.</label>

        <p class="small" style="margin-top:1rem; color:#333;">
          Hinweis: Der Vertrag kommt erst mit Zahlungseingang zustande.
        </p>

        <div id="form-message" class="small" style="margin-top:.5rem;"></div>

        <div class="form-actions">
          <button id="proceedToPayBtn" type="button" class="btn hidden">Weiter zur Zahlung</button>
        </div>
      </form>
    </section>

  </main>

<script>
const FORMSPREE_ENDPOINT = "https://formspree.io/f/mldlyqdz";
const REDIRECT_AFTER_PAYMENT = "danke.html";
let cart = JSON.parse(localStorage.getItem("cart") || "[]");

function getCartTotal(){ return cart.reduce((s,i)=>s+i.price*i.qty,0); }
function cartContainsCourse(){ return cart.some(i => (i.name||"").includes("Termin:")); }

function updateCartDisplay(){
  const list = document.getElementById("cart-items"); list.innerHTML="";
  cart.forEach(item=>{
    const li=document.createElement("li");
    li.innerHTML=`<div style='flex:1'><div>${item.name}</div><div class='small muted'>${item.qty} √ó ${item.price.toFixed(2)} ‚Ç¨</div></div><div>${(item.price*item.qty).toFixed(2)} ‚Ç¨</div>`;
    list.appendChild(li);
  });
  document.getElementById("cart-total").innerText = getCartTotal().toFixed(2);
}

function initCheckoutUI(){
  updateCartDisplay();

  const hasCourse = cartContainsCourse();
  const regForm = document.getElementById("registrationForm");

  if(hasCourse) regForm.classList.remove("hidden");
  else regForm.classList.add("hidden");

  document.getElementById("anzahlTeilnehmer").addEventListener("change", buildSubForms);
  document.getElementById("proceedToPayBtn").addEventListener("click", initPayPal);
}

function buildSubForms(){
  const n = parseInt(document.getElementBy
