<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kasse ‚Äî Survival Kurse & Kits</title>

  <!-- F√ºge hier dein CSS ein oder verlinke deine Stylesheets -->
  <style>
    /* Minimal styles f√ºr √úbersicht ‚Äî passe an dein Theme an */
    body { font-family: system-ui, sans-serif; padding: 1rem; color:#222; }
    .container { max-width:900px; margin:0 auto; display:grid; grid-template-columns: 1fr 360px; gap:1.5rem; }
    h1 { color: var(--dark-green, #0f5132); }
    .card { background:#fff; border:1px solid #eee; padding:1rem; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.03); }
    .muted { color:#666; font-size:0.95rem; }
    .btn { display:inline-block; padding:0.6rem 1rem; border-radius:6px; border:none; background:#0f5132; color:#fff; cursor:pointer; }
    .btn:disabled { opacity:0.5; cursor:not-allowed; }
    .cart-list { list-style:none; padding:0; margin:0 0 1rem 0; }
    .cart-list li { padding:0.4rem 0; border-bottom:1px dashed #eee; display:flex; justify-content:space-between; align-items:center; }
    .small { font-size:0.9rem; }
    .success { color:green; }
    .error { color:red; }
    label { display:block; margin-top:0.75rem; font-weight:600; }
    input[type="text"], input[type="email"], input[type="tel"], input[type="date"], select { width:100%; padding:0.5rem; margin-top:0.25rem; border:1px solid #ddd; border-radius:6px; }
    .form-actions { margin-top:1rem; display:flex; gap:.5rem; align-items:center; }
    .hidden { display:none !important; }
    .center { text-align:center; }
    @media (max-width:900px) { .container { grid-template-columns: 1fr; } }
  </style>

  <!-- WICHTIG: PayPal SDK einbinden (ersetze CLIENT-ID durch deine): -->
  <!-- <script src="https://www.paypal.com/sdk/js?client-id=YOUR_CLIENT_ID&currency=EUR"></script> -->
</head>
<body>
  <main class="container">
    <!-- =============== LINKS: Formular & Checkout-Status =============== -->
    <section class="card" id="checkout-left">
      <h1>Kasse</h1>
      <p class="muted">Bitte √ºberpr√ºfe deine Bestellung, f√ºlle das Formular (wenn erforderlich) aus und fahre mit der Zahlung fort.</p>

      <!-- === Gutscheincode (in Kasse verf√ºgbar) === -->
      <div id="voucher-section" style="margin-top:1rem;">
        <h3>üéüÔ∏è Gutscheincode einl√∂sen</h3>
        <label for="voucherCode">Gutscheincode</label>
        <input type="text" id="voucherCode" placeholder="Code eingeben">

        <label for="customerEmail">Deine E-Mail-Adresse</label>
        <input type="email" id="customerEmail" placeholder="name@example.com">

        <div class="form-actions">
          <button onclick="submitVoucherRequest()" class="btn">Einl√∂sen</button>
          <span id="voucherMessage" class="small"></span>
        </div>
      </div>

      <hr style="margin:1rem 0;">

      <!-- === Anmeldeformular (dein vorhandenes Formular, exakt √ºbernommen) === -->
      <form id="registrationForm" class="hidden" onsubmit="event.preventDefault(); handleFormSubmit();">
        <h2 style="color:var(--dark-green); margin-top:1rem;">Teilnehmerdaten</h2>

        <input type="text" name="vorname" id="vorname" placeholder="Vorname" required>
        <input type="text" name="nachname" id="nachname" placeholder="Nachname" required>

        <input type="text" name="strasse" id="strasse" placeholder="Stra√üe & Hausnummer" required>
        <input type="text" name="plz_ort" id="plz_ort" placeholder="PLZ & Ort" required>

        <input type="email" name="email" id="teilnehmer_email" placeholder="E-Mail-Adresse" required>
        <input type="tel" name="telefon" id="telefon" placeholder="Telefonnummer (optional)">

        <label style="font-weight:bold; margin-top:1rem;">Geburtsdatum *</label>
        <input type="date" name="geburtsdatum" id="geburtsdatum" required>

        <label style="font-weight:bold; margin-top:2rem;">Minderj√§hriger Teilnehmer?</label>
        <select id="minderjaehrig-toggle" name="minderjaehrig" class="terminfenster">
          <option value="nein">Nein</option>
          <option value="ja">Ja</option>
        </select>

        <div id="minderjaehrig-felder" style="display:none; margin-top:1rem;">
          <input type="text" name="kind_name" id="kind_name" placeholder="Name des Kindes">
          <input type="number" name="kind_alter" id="kind_alter" placeholder="Alter des Kindes" min="1" max="17">
        </div>

        <h2 style="color:var(--dark-green); margin-top:2rem;">Best√§tigungen</h2>

        <label><input type="checkbox" id="agb" required> Ich habe die AGB gelesen und akzeptiere sie.</label>
        <label><input type="checkbox" id="fitness" required> Ich best√§tige, dass ich k√∂rperlich und mental f√ºr die Kursinhalte geeignet bin.</label>
        <label><input type="checkbox" id="haftung" required> Ich best√§tige den Haftungsausschluss.</label>

        <p style="font-size:0.9rem; color:#333; margin-top:1rem;">
          Hinweis: Der Vertrag kommt erst mit Zahlungseingang zustande.
        </p>

        <div id="form-message" class="small" style="margin-top:.5rem;"></div>

        <div class="form-actions">
          <!-- "Weiter zur Zahlung" erscheint nach Validierung -->
          <button id="proceedToPayBtn" type="button" class="btn hidden">Weiter zur Zahlung</button>
        </div>
      </form>
    </section>

    <!-- =============== RECHTS: Warenkorb & PayPal =============== -->
    <aside class="card" id="checkout-right">
      <h2>Dein Warenkorb</h2>
      <ul id="cart-items" class="cart-list"></ul>
      <p><strong>Gesamt: <span id="cart-total">0.00</span> ‚Ç¨</strong></p>

      <div id="pay-area" style="margin-top:1rem;">
        <!-- Hier werden PayPal-Buttons gerendert (oder "Jetzt bezahlen" f√ºr Kits) -->
        <div id="paypal-button-container"></div>

        <!-- Fallback / Info, falls PayPal SDK fehlt -->
        <div id="paypal-missing" class="hidden small error" style="margin-top:.5rem;">
          PayPal-Script wird ben√∂tigt. Bitte binde das PayPal SDK ein (siehe Kommentar in Quelle).
        </div>
      </div>

      <p class="muted small" style="margin-top:1rem;</p>
    </aside>
  </main>

  <script>
  /*******************************
   * kasse.html ‚Äî Checkout-Logik *
   *******************************/

  // --- Konfiguration ---
  const FORMSPREE_ENDPOINT = "https://formspree.io/f/mldlyqdz"; // wie im cart.html
  const REDIRECT_AFTER_PAYMENT = "danke.html";

  // --- Zustand ---
  let cart = JSON.parse(localStorage.getItem("cart") || "[]");
  let voucherApplied = JSON.parse(localStorage.getItem("voucher_applied") || "null"); // { code, email } oder null

  // --- Utilities ---
  function getCartTotal() {
    return cart.reduce((s, i) => s + i.price * i.qty, 0);
  }

  function cartContainsCourse() {
    // Annahme: Kurse haben Namen wie "Kursname ‚Äì Termin: ..." aus deiner cart-Logik.
    return cart.some(i => (i.name || "").indexOf("Termin:") > -1);
  }

  // --- Anzeige Warenkorb ---
  function updateCartDisplay() {
    const list = document.getElementById("cart-items");
    list.innerHTML = "";
    cart.forEach((item, i) => {
      const li = document.createElement("li");
      li.innerHTML = `
        <div style="flex:1">
          <div>${item.name}</div>
          <div class="small muted">${item.qty} √ó ${item.price.toFixed(2)} ‚Ç¨</div>
        </div>
        <div style="text-align:right">${(item.price * item.qty).toFixed(2)} ‚Ç¨</div>
      `;
      list.appendChild(li);
    });

    document.getElementById("cart-total").innerText = getCartTotal().toFixed(2);
  }

  // --- Initial UI-Setup basierend auf Warenkorb & Gutscheinstatus ---
  function initCheckoutUI() {
    updateCartDisplay();

    // Voucher UI (wenn bereits eingel√∂st, zeigen wir den Text und blockieren Zahlung)
    if (voucherApplied && voucherApplied.code) {
      showVoucherAppliedMessage(`Vielen Dank! Dein Gutscheincode wurde eingel√∂st und wird nun gepr√ºft. Du bekommst in K√ºrze eine Mail mit deiner angepassten Rechnung.`);
      blockPaymentsBecauseVoucher();
    }

    const hasCourse = cartContainsCourse();
    const registrationForm = document.getElementById("registrationForm");

    if (hasCourse) {
      // Form anzeigen (Pflicht)
      registrationForm.classList.remove("hidden");
      // PayPal buttons nicht sofort rendern ‚Äî erst nach Formularvalidierung / Klick "Weiter zur Zahlung"
      hidePaypalContainer();
    } else {
      // Keine Kurse -> Formular ausblenden und sofort PayPal zeigen (sofern kein Gutschein)
      registrationForm.classList.add("hidden");
      if (!isVoucherActive()) initPayPal(); // render PayPal sofort, falls SDK vorhanden
    }

    // Minderj√§hrigen Toggle (Form)
    const toggle = document.getElementById('minderjaehrig-toggle');
    const felder = document.getElementById('minderjaehrig-felder');
    if (toggle) {
      toggle.addEventListener('change', () => {
        felder.style.display = toggle.value === 'ja' ? 'block' : 'none';
      });
    }

    // Proceed button handler (nach Formularvalidierung)
    document.getElementById("proceedToPayBtn").addEventListener("click", () => {
      // Nach erfolgreicher Validierung PayPal initialisieren
      initPayPal();
      // Optional: Scroll to PayPal area
      document.getElementById("paypal-button-container").scrollIntoView({ behavior: "smooth" });
    });
  }

  // --- Voucher Helpers ---
  function isVoucherActive() {
    return voucherApplied && voucherApplied.code;
  }

  function showVoucherAppliedMessage(text) {
    const msg = document.getElementById("voucherMessage");
    if (!msg) return;
    msg.className = "success";
    msg.textContent = text;
  }

  function blockPaymentsBecauseVoucher() {
    // Versteckt PayPal / Weiter zur Zahlung und zeigt Info
    hidePaypalContainer();
    document.getElementById("proceedToPayBtn").classList.add("hidden");
  }

  function unblockPayments() {
    // Entfernt Voucher-Block, zeigt PayPal bzw. erm√∂glicht Weiter zur Zahlung (abh√§ngig von Kartentyp)
    const hasCourse = cartContainsCourse();
    if (hasCourse) {
      document.getElementById("proceedToPayBtn").classList.remove("hidden");
      hidePaypalContainer();
    } else {
      document.getElementById("proceedToPayBtn").classList.add("hidden");
      initPayPal();
    }
  }

  // --- Formspree Gutschein-Funktion (kopiert / angepasst aus cart.html) ---
  async function submitVoucherRequest() {
    const code = document.getElementById("voucherCode").value.trim();
    const email = document.getElementById("customerEmail").value.trim();
    const msgEl = document.getElementById("voucherMessage");

    if (!code) {
      msgEl.className = "error";
      msgEl.textContent = "Bitte Gutscheincode eingeben.";
      return;
    }

    if (!email || !email.includes("@")) {
      msgEl.className = "error";
      msgEl.textContent = "Bitte g√ºltige E-Mail-Adresse eingeben.";
      return;
    }

    msgEl.className = "success";
    msgEl.textContent = "Vielen Dank! Dein Gutscheincode wurde eingel√∂st und wird nun gepr√ºft. Du bekommst in K√ºrze eine Mail mit deiner angepassten Rechnung.";

    // Felder zur√ºcksetzen wie im cart.html (UX)
    setTimeout(() => {
      document.getElementById("voucherCode").value = "";
      document.getElementById("customerEmail").value = "";
    }, 1000);

    try {
      const response = await fetch(FORMSPREE_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          _subject: "ü™ô Neuer Gutschein eingel√∂st",
          code: code,
          kunden_email: email,
          warenkorb_summe: getCartTotal().toFixed(2),
          warenkorb_inhalt: cart.map(i => `${i.name} x${i.qty}`).join("; ")
        }),
      });

      if (!response.ok) throw new Error(`Fehler beim Senden (${response.status})`);

      // Falls erfolgreich: merke Gutschein lokal und blockiere Zahlungen (wie gew√ºnscht)
      voucherApplied = { code, email };
      localStorage.setItem("voucher_applied", JSON.stringify(voucherApplied));
      showVoucherAppliedMessage("Vielen Dank! Dein Gutscheincode wurde eingel√∂st und wird nun gepr√ºft. Du bekommst in K√ºrze eine Mail mit deiner angepassten Rechnung.");
      blockPaymentsBecauseVoucher();

    } catch (err) {
      console.error("‚ö†Ô∏è Fehler beim Senden an Formspree:", err);
      msgEl.className = "error";
      msgEl.textContent = "‚ö†Ô∏è Gutschein konnte aus technischen Gr√ºnden nicht gesendet werden. Bitte schicke den Code per Kontaktformular oder Mail, wir werden uns umgehend bei dir melden.";
    }

    setTimeout(() => {
      // kurze Aufr√§umaktion: entferne den Hinweis nach 8s (wie vorher)
      const msg = document.getElementById("voucherMessage");
      if (msg && !isVoucherActive()) msg.textContent = "";
    }, 8000);
  }

  // --- Registration form handling ---
  function validateRegistrationForm() {
    // Einfache Validierung: required Felder, Checkboxen, E-Mail-Format
    const requiredIds = ["vorname", "nachname", "strasse", "plz_ort", "teilnehmer_email", "geburtsdatum", "agb", "fitness", "haftung"];
    const msgEl = document.getElementById("form-message");
    msgEl.textContent = "";

    // Check simple inputs
    const vorname = document.getElementById("vorname").value.trim();
    const nachname = document.getElementById("nachname").value.trim();
    const strasse = document.getElementById("strasse").value.trim();
    const plzOrt = document.getElementById("plz_ort").value.trim();
    const email = document.getElementById("teilnehmer_email").value.trim();
    const geb = document.getElementById("geburtsdatum").value;
    const agb = document.getElementById("agb").checked;
    const fitness = document.getElementById("fitness").checked;
    const haftung = document.getElementById("haftung").checked;

    if (!vorname || !nachname || !strasse || !plzOrt || !email || !geb) {
      msgEl.className = "error";
      msgEl.textContent = "Bitte f√ºlle alle Pflichtfelder aus.";
      return false;
    }

    if (!email.includes("@")) {
      msgEl.className = "error";
      msgEl.textContent = "Bitte gib eine g√ºltige E-Mail-Adresse an.";
      return false;
    }

    if (!agb || !fitness || !haftung) {
      msgEl.className = "error";
      msgEl.textContent = "Bitte best√§tige alle Pflichtbest√§tigungen.";
      return false;
    }

    // alles gut
    msgEl.className = "success";
    msgEl.textContent = "Formular ist vollst√§ndig. Klicke auf 'Weiter zur Zahlung'.";
    return true;
  }

  function handleFormSubmit() {
    // Wir wollen nicht direkt versenden ‚Äî stattdessen aktivieren wir den "Weiter zur Zahlung" Button
    const ok = validateRegistrationForm();
    if (ok) {
      document.getElementById("proceedToPayBtn").classList.remove("hidden");
    }
  }

  // --- PayPal: init & render ---
  function showPaypalMissing() {
    document.getElementById("paypal-missing").classList.remove("hidden");
  }

  function hidePaypalContainer() {
    document.getElementById("paypal-button-container").innerHTML = "";
    document.getElementById("paypal-missing").classList.add("hidden");
  }

  function initPayPal() {
    // Falls Gutschein aktiv -> kein PayPal
    if (isVoucherActive()) {
      hidePaypalContainer();
      return;
    }

    // PayPal SDK vorhanden?
    if (typeof paypal === "undefined") {
      showPaypalMissing();
      return;
    }

    const cont = document.getElementById("paypal-button-container");
    cont.innerHTML = ""; // sauber starten

    if (!cart || cart.length === 0) {
      cont.innerHTML = "<div class='small muted'>Dein Warenkorb ist leer.</div>";
      return;
    }

    // Erstelle Bestellung bei PayPal
    paypal.Buttons({
      createOrder: (data, actions) => {
        return actions.order.create({
          purchase_units: [{
            description: cart.map(i => `${i.name} x${i.qty}`).join("; "),
            amount: {
              currency_code: "EUR",
              value: getCartTotal().toFixed(2)
            }
          }]
        });
      },
      onApprove: (data, actions) => {
        return actions.order.capture().then(function(details) {
          // Nach erfolgreicher Zahlung: Warenkorb leeren, Voucher entfernen, redirect
          localStorage.removeItem("cart");
          localStorage.removeItem("voucher_applied");
          // kleine Best√§tigungs-Alert (optional)
          try { alert("Danke, " + (details.payer?.name?.given_name || "") + "! Zahlung erhalten."); } catch(e){}
          window.location.href = REDIRECT_AFTER_PAYMENT;
        });
      },
      onError: (err) => {
        console.error("PayPal Fehler:", err);
        alert("‚ö†Ô∏è Zahlung fehlgeschlagen. Bitte erneut versuchen.");
      }
    }).render('#paypal-button-container');
  }

  // --- Page lifecycle ---
  document.addEventListener("DOMContentLoaded", () => {
    initCheckoutUI();

    // Wenn kein Kurs im Warenkorb, PayPal wird direkt initialisiert (sofern kein Gutschein)
    if (!cartContainsCourse() && !isVoucherActive()) initPayPal();
  });

  // --- Expose voucher function for button onclick ---
  window.submitVoucherRequest = submitVoucherRequest;

  // --- Debug helpers (optional in dev) ---
  // window._debug = { cart, getCartTotal, cartContainsCourse };

  </script>
</body>
</html>
