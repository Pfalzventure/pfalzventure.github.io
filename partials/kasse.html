<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kasse</title>

  <!-- Minimal styles f√ºr √úbersicht ‚Äî passe an dein Theme an -->
  <style>
    body { font-family: system-ui, sans-serif; padding: 1rem; color:#222; background:#f5f5dc; }
    .container { max-width:900px; margin:0 auto; display:grid; grid-template-columns: 1fr 360px; gap:1.5rem; }
    h1 { color: var(--dark-green, #0f5132); margin:0 0 .5rem 0; }
    .card { background:#fff; border:1px solid #eee; padding:1rem; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.03); }
    .muted { color:#666; font-size:0.95rem; }
    .btn { display:inline-block; padding:0.6rem 1rem; border-radius:6px; border:none; background:#0f5132; color:#fff; cursor:pointer; text-decoration:none; }
    .btn:disabled { opacity:0.5; cursor:not-allowed; }
    .cart-list { list-style:none; padding:0; margin:0 0 1rem 0; }
    .cart-list li { padding:0.4rem 0; border-bottom:1px dashed #eee; display:flex; justify-content:space-between; align-items:center; }
    .small { font-size:0.9rem; }
    .success { color:green; }
    .error { color:red; }
    label { display:block; margin-top:0.75rem; font-weight:600; }
    input[type="text"], input[type="email"], input[type="tel"], input[type="date"], input[type="number"], select { width:100%; padding:0.5rem; margin-top:0.25rem; border:1px solid #ddd; border-radius:6px; box-sizing:border-box; }
    .form-actions { margin-top:1rem; display:flex; gap:.5rem; align-items:center; }
    .hidden { display:none !important; }
    .center { text-align:center; }
    .right-aux { margin-top:1rem; }

    /* Infobox */
    .info-box {
      margin-top: 1rem;
      background: #e7f7ee;
      border-left: 4px solid #0f5132;
      padding: 0.75rem 1rem;
      border-radius: 6px;
      color: #0b3b2a;
    }

    /* Sidebar sticky (Option 1) */
    #checkout-right { position:sticky; top:1rem; align-self:start; }

    @media (max-width:900px) { .container { grid-template-columns: 1fr; } #checkout-right { position: static; } }
  </style>

<link rel="stylesheet" href="../style.css">
  
 <!-- PayPal SDK (ersetze client-id durch deine Live/Sandbox-ID) -->
  <script src="https://www.paypal.com/sdk/js?client-id=Abafm4k5xNnVRQ7UnZmQFYWYJ2_dtwU9u1ubHTo9cC2KUjoD8no3TZgZBHI_hiLqvRQHkLxFAjpU6fEJ&currency=EUR"></script>
  
</head>
<body>
  <main class="container">
    <!-- =============== LINKS: Formular & Checkout-Status =============== -->
    <section class="card" id="checkout-left">
      <h1>Kasse</h1>
      <p class="muted">Bitte √ºberpr√ºfe deine Bestellung, f√ºlle das Formular aus (nur notwendig bei Teilnahme an einem der Kurse) und fahre mit der Zahlung fort.</p>

  <form id="registrationForm" class="hidden">
  <h2 style="color:var(--dark-green); margin-top:1rem;">Teilnehmerdaten</h2>

  <!-- Teilnehmer 1 (Vertragspartner) -->
  <div id="participant1" class="participant-block">
    <h3>Teilnehmer 1</h3>

    <input type="text" name="vorname" id="vorname" placeholder="Vorname" required>
    <input type="text" name="nachname" id="nachname" placeholder="Nachname" required>

    <input type="text" name="strasse" id="strasse" placeholder="Stra√üe & Hausnummer" required>
    <input type="text" name="plz_ort" id="plz_ort" placeholder="PLZ & Ort" required>

    <input type="email" name="email" id="teilnehmer_email" placeholder="E-Mail-Adresse" required>
    <input type="tel" name="telefon" id="telefon" placeholder="Telefonnummer (optional)">

    <label style="font-weight:bold; margin-top:1rem;">Geburtsdatum</label>
    <input type="date" name="geburtsdatum" id="geburtsdatum" required>

    <!-- Hinweis zu Minderj√§hrigen wird extern geregelt -->
  </div>

  <!-- Dropdown Anzahl Teilnehmer (unterhalb des Anmeldeformulars von Teilnehmer 1 wie gew√ºnscht) -->
  <div style="margin-top:1rem;">
    <label for="participantCount" style="font-weight:600;">Anzahl Teilnehmer (inkl. Teilnehmer 1)</label>
    <select id="participantCount" style="margin-left:.5rem;">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>
  </div>

  <!-- Container f√ºr zus√§tzliche Teilnehmerformulare -->
  <div id="additional-participants" style="margin-top:1rem;"></div>

  <h2 style="color:var(--dark-green); margin-top:2rem;">Best√§tigungen</h2>

  <label>
    <input type="checkbox" id="agb" required>
    Ich habe die <a href="../AGB.html">AGB</a> gelesen und akzeptiere sie. Ich best√§tige, dass die Teilnahmebedingungen f√ºr alle angegebenen Teilnehmer gelten.
  </label>

  <label>
    <input type="checkbox" id="fitness" required>
    Ich best√§tige, dass ich k√∂rperlich und mental f√ºr die Kursinhalte geeignet bin (gilt auch f√ºr alle anderen angegebenen Teilnehmer).
  </label>

  <!-- Hervorgehobene Infobox unter den Best√§tigungen -->
  <div class="info-box" role="note" aria-live="polite">
    <strong>Wichtige Hinweise:</strong>
    <ul style="margin:0.5rem 0 0 1.1rem; padding:0;">
      <li>Minderj√§hrige d√ºrfen nur in Begleitung eines Erwachsenen teilnehmen, der die Aufsichtspflicht f√ºr sie √ºbernimmt.</li>
      <li>Der Vertrag kommt erst mit Zahlungseingang zustande.</li>
    </ul>
  </div>

  <div id="form-message" class="small" style="margin-top:.5rem;"></div>

  <div class="form-actions">
    <button id="proceedToPayBtn" type="button" class="btn hidden">Weiter zur Zahlung</button>
  </div>
</form>
      
     <!-- === Anmeldeformular (bereinigt) === -->
</section>

<!-- =============== RECHTS: Warenkorb, Gutschein (oben Warenkorb, darunter Gutschein) & PayPal =============== -->
    <aside class="card" id="checkout-right">
      <h2>Dein Warenkorb</h2>

      <ul id="cart-items" class="cart-list"></ul>
      <p><strong>Gesamt: <span id="cart-total">0.00</span> ‚Ç¨</strong></p>

      <!-- Button zur√ºck zur Startseite -->
<button class="btn add-btn back-home-btn" onclick="window.location.href='../index.html'">
  Zur Startseite
</button>


      <!-- === Gutscheincode: unter Warenkorb === -->
      <div id="voucher-section" style="margin-top:1rem;">
        <h3>üéüÔ∏è Gutscheincode einl√∂sen</h3>
        <label for="voucherCode">Gutscheincode</label>
        <input type="text" id="voucherCode" placeholder="Code eingeben">

        <label for="customerEmail">Deine E-Mail-Adresse</label>
        <input type="email" id="customerEmail" placeholder="name@example.com">

        <div class="form-actions">
          <button onclick="submitVoucherRequest()" class="btn add-btn">Einl√∂sen</button>
          <span id="voucherMessage" class="small" style="margin-left:.5rem;"></span>
        </div>
      </div>

      <div id="pay-area" style="margin-top:1rem;">
        <!-- Hier werden PayPal-Buttons gerendert (oder "Jetzt bezahlen" f√ºr Kits) -->
        <div id="paypal-button-container"></div>

        <!-- Fallback / Info, falls PayPal SDK fehlt -->
        <div id="paypal-missing" class="hidden small error" style="margin-top:.5rem;">
          PayPal-Script wird ben√∂tigt. Bitte binde das PayPal SDK ein (siehe Kommentar in Quelle).
        </div>
      </div>
    </aside>

  </main>

<script>
/*******************************
 * kasse.html ‚Äî Checkout-Logik (korrigiert)
 *******************************/

const FORMSPREE_ENDPOINT = "https://formspree.io/f/mldlyqdz";
const REDIRECT_AFTER_PAYMENT = "danke-bestellung.html";

let cart = JSON.parse(localStorage.getItem("cart") || "[]");
let voucherApplied = null;

// Utilities
function getCartTotal() {
  return cart.reduce((s, i) => s + i.price * i.qty, 0);
}
function cartContainsCourse() {
  return cart.some(i => (i.name || "").indexOf("Termin:") > -1);
}

// --- Update Cart UI ---
function updateCartDisplay() {
  const list = document.getElementById("cart-items");
  if (!list) return;
  list.innerHTML = "";
  cart.forEach((item) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <div style="flex:1">
        <div>${item.name}</div>
        <div class="small muted">${item.qty} √ó ${item.price.toFixed(2)} ‚Ç¨</div>
      </div>
      <div style="text-align:right">${(item.price * item.qty).toFixed(2)} ‚Ç¨</div>
    `;
    list.appendChild(li);
  });
  const totalEl = document.getElementById("cart-total");
  if (totalEl) totalEl.innerText = getCartTotal().toFixed(2);
  if (!cart || cart.length === 0) {
    const cont = document.getElementById("paypal-button-container");
    if (cont) cont.innerHTML = "<div class='small muted'>Dein Warenkorb ist leer.</div>";
  }
}

// --- Init UI ---
function initCheckoutUI() {
  voucherApplied = null;
  const voucherMsg = document.getElementById("voucherMessage");
  if (voucherMsg) { voucherMsg.textContent = ""; voucherMsg.className = "small"; }

  updateCartDisplay();

  const registrationForm = document.getElementById("registrationForm");
  const hasCourse = cartContainsCourse();

  if (hasCourse) {
    registrationForm.classList.remove("hidden");
    hidePaypalContainer(); // PayPal erst nach Formularvalidierung
  } else {
    registrationForm.classList.add("hidden");
    if (!isVoucherActive()) initPayPal();
  }

  // Teilnehmeranzahl
  const countSelect = document.getElementById('participantCount');
  if (countSelect) {
    countSelect.addEventListener('change', renderAdditionalParticipants);
  }

  // initial render (1)
  renderAdditionalParticipants();

  // Wire up proceed button (pr√ºfe Element vorhanden)
  const proceedBtn = document.getElementById("proceedToPayBtn");
  if (proceedBtn) {
    proceedBtn.addEventListener("click", async () => {
      if (!validateRegistrationForm()) return;
      // Erst Formular an Formspree senden, dann PayPal initialisieren
      await sendRegistrationToFormspree();
      initPayPal();
      const cont = document.getElementById("paypal-button-container");
      if (cont) cont.scrollIntoView({ behavior: "smooth" });
    });
  }

  // Watch basic fields for showing proceed button
  const watchSelectors = [
    "#vorname", "#nachname", "#strasse", "#plz_ort",
    "#teilnehmer_email", "#geburtsdatum",
    "#agb", "#fitness"
  ];
  watchSelectors.forEach(sel => {
    const el = document.querySelector(sel);
    if (!el) return;
    const ev = (el.tagName === "SELECT" || el.type === "checkbox" || el.type === "radio" || el.type === "date") ? "change" : "input";
    el.addEventListener(ev, updateProceedVisibility);
  });

  updateProceedVisibility();
}

// --- Voucher helpers & Anpassung: pr√ºfe Formular wenn Kurs im Warenkorb ---
function isVoucherActive() {
  return voucherApplied && voucherApplied.code;
}
function showVoucherAppliedMessage(text) {
  const msg = document.getElementById("voucherMessage");
  if (!msg) return;
  msg.className = "success";
  msg.textContent = text;
}
function blockPaymentsBecauseVoucher() {
  hidePaypalContainer();
  document.getElementById("proceedToPayBtn").classList.add("hidden");
}
function unblockPayments() {
  const hasCourse = cartContainsCourse();
  if (hasCourse) {
    document.getElementById("proceedToPayBtn").classList.remove("hidden");
    hidePaypalContainer();
  } else {
    document.getElementById("proceedToPayBtn").classList.add("hidden");
    initPayPal();
  }
}

async function submitVoucherRequest() {
  const code = document.getElementById("voucherCode").value.trim();
  const email = document.getElementById("customerEmail").value.trim();
  const msgEl = document.getElementById("voucherMessage");

  if (!code) {
    if (msgEl) { msgEl.className = "error"; msgEl.textContent = "Bitte Gutscheincode eingeben."; }
    return;
  }
  if (!email || !email.includes("@")) {
    if (msgEl) { msgEl.className = "error"; msgEl.textContent = "Bitte g√ºltige E-Mail-Adresse eingeben."; }
    return;
  }

  // Wenn Kurs im Warenkorb liegt -> Formularsichtbar sein & validiert sein m√ºssen
  if (cartContainsCourse()) {
    const regForm = document.getElementById("registrationForm");
    const formVisible = regForm && !regForm.classList.contains("hidden");
    if (formVisible && !validateRegistrationForm()) {
      if (msgEl) { msgEl.className = "error"; msgEl.textContent = "Bitte f√ºlle zuerst das Anmeldeformular vollst√§ndig aus."; }
      return;
    }
  }

  if (msgEl) { msgEl.className = "success"; msgEl.textContent = "Vielen Dank! Dein Gutscheincode wurde eingereicht und wird gepr√ºft."; }

  setTimeout(() => {
    const el = document.getElementById("voucherCode"); if (el) el.value = "";
    const em = document.getElementById("customerEmail"); if (em) em.value = "";
  }, 800);

  try {
    const response = await fetch(FORMSPREE_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        _subject: "ü™ô Neuer Gutschein eingel√∂st",
        code: code,
        kunden_email: email,
        warenkorb_summe: getCartTotal().toFixed(2),
        warenkorb_inhalt: cart.map(i => `${i.name} x${i.qty}`).join("; ")
      }),
    });

    if (!response.ok) throw new Error(`Fehler beim Senden (${response.status})`);

    voucherApplied = { code, email };
    showVoucherAppliedMessage("Vielen Dank! Dein Gutscheincode wurde eingereicht und wird nun gepr√ºft. Du bekommst eine angepasste Rechnung per Mail.");
    blockPaymentsBecauseVoucher();

  } catch (err) {
    console.error("‚ö†Ô∏è Fehler beim Senden an Formspree:", err);
    if (msgEl) { msgEl.className = "error"; msgEl.textContent = "‚ö†Ô∏è Gutschein konnte nicht gesendet werden. Bitte kontaktiere uns per Mail."; }
  }

  setTimeout(() => {
    const msg = document.getElementById("voucherMessage");
    if (msg && !isVoucherActive()) msg.textContent = "";
  }, 8000);
}
window.submitVoucherRequest = submitVoucherRequest;

// --- Dynamisches Erzeugen zus√§tzlicher Teilnehmer (ohne Minderj√§hrig + ohne Copy-Buttons) ---
function renderAdditionalParticipants() {
  const container = document.getElementById('additional-participants');
  const count = parseInt(document.getElementById('participantCount').value, 10) || 1;
  container.innerHTML = "";

  // Wir beginnen bei 2, da Teilnehmer 1 bereits im DOM ist
  for (let i = 2; i <= count; i++) {
    const block = document.createElement('div');
    block.className = 'participant-block';
    block.style.marginTop = '1rem';
    block.id = `participant_block_${i}`;

    block.innerHTML = `
      <h4>Teilnehmer ${i}</h4>
      <input type="text" id="vorname_${i}" placeholder="Vorname" required>
      <input type="text" id="nachname_${i}" placeholder="Nachname" required>
      <label style="font-weight:bold; margin-top:.5rem;">Geburtsdatum</label>
      <input type="date" id="geburtsdatum_${i}" required>
      <div style="margin-top:.5rem;">
        <button type="button" class="btn small" id="remove_${i}">Entfernen</button>
      </div>
    `;
    container.appendChild(block);

    document.getElementById(`remove_${i}`).addEventListener('click', () => {
      // set participantCount to current -1 and re-render
      const sel = document.getElementById('participantCount');
      const newCount = Math.max(1, parseInt(sel.value, 10) - 1);
      sel.value = newCount;
      renderAdditionalParticipants();
      updateProceedVisibility();
    });

    // Watch fields for validation trigger
    ['vorname','nachname','geburtsdatum'].forEach(f => {
      const el = document.getElementById(`${f}_${i}`);
      if (!el) return;
      el.addEventListener('input', updateProceedVisibility);
    });
  }
}

// --- Validation ---
function validateRegistrationForm() {
  const msgEl = document.getElementById("form-message");
  msgEl.textContent = "";

  // Wenn kein Kurs im Warenkorb liegt, Formular muss nicht zwingend ausgef√ºllt sein (aber proceed bleibt hidden)
  if (!cartContainsCourse()) {
    return true;
  }

  // Teilnehmer 1 checks (contract partner)
  const vorname = document.getElementById("vorname").value.trim();
  const nachname = document.getElementById("nachname").value.trim();
  const strasse = document.getElementById("strasse").value.trim();
  const plzOrt = document.getElementById("plz_ort").value.trim();
  const email = document.getElementById("teilnehmer_email").value.trim();
  const geb = document.getElementById("geburtsdatum").value;
  const agb = document.getElementById("agb").checked;
  const fitness = document.getElementById("fitness").checked;

  if (!vorname || !nachname || !strasse || !plzOrt || !email || !geb) {
    msgEl.className = "error";
    msgEl.textContent = "Bitte f√ºlle alle Pflichtfelder des Vertragspartners (Teilnehmer 1) aus.";
    return false;
  }
  if (!email.includes("@")) {
    msgEl.className = "error";
    msgEl.textContent = "Bitte gib eine g√ºltige E-Mail-Adresse an.";
    return false;
  }
  if (!agb || !fitness) {
    msgEl.className = "error";
    msgEl.textContent = "Bitte best√§tige AGB und Fitness (gilt f√ºr alle Teilnehmer).";
    return false;
  }

  // Zus√§tzliche Teilnehmer pr√ºfen (ohne Minderj√§hrig-Checks)
  const count = parseInt(document.getElementById('participantCount').value || "1", 10);
  for (let i = 2; i <= count; i++) {
    const v = document.getElementById(`vorname_${i}`)?.value?.trim();
    const n = document.getElementById(`nachname_${i}`)?.value?.trim();
    const g = document.getElementById(`geburtsdatum_${i}`)?.value;

    if (!v || !n || !g) {
      msgEl.className = "error";
      msgEl.textContent = `Bitte f√ºlle alle Pflichtfelder f√ºr Teilnehmer ${i} (Vorname, Nachname, Geburtsdatum).`;
      return false;
    }
  }

  msgEl.className = "success";
  msgEl.textContent = "Formular ist vollst√§ndig. Klicke auf 'Weiter zur Zahlung'.";
  return true;
}

// Update Proceed Button visibility based on validation
function updateProceedVisibility() {
  const proceedBtn = document.getElementById("proceedToPayBtn");
  if (!proceedBtn) return;
  // Only show proceed if cart contains course and validation passes
  if (cartContainsCourse()) {
    const ok = validateRegistrationForm();
    if (ok) proceedBtn.classList.remove("hidden");
    else proceedBtn.classList.add("hidden");
  } else {
    proceedBtn.classList.add("hidden");
  }
}

// --- Send registration to Formspree ---
async function sendRegistrationToFormspree() {
  const participant1 = {
    vorname: document.getElementById("vorname").value.trim(),
    nachname: document.getElementById("nachname").value.trim(),
    strasse: document.getElementById("strasse").value.trim(),
    plz_ort: document.getElementById("plz_ort").value.trim(),
    email: document.getElementById("teilnehmer_email").value.trim(),
    telefon: document.getElementById("telefon").value.trim(),
    geburtsdatum: document.getElementById("geburtsdatum").value,
    agb: document.getElementById("agb").checked ? "ja" : "nein",
    fitness: document.getElementById("fitness").checked ? "ja" : "nein"
  };

  const participants_additional = [];
  const count = parseInt(document.getElementById('participantCount').value || "1", 10);
  for (let i = 2; i <= count; i++) {
    participants_additional.push({
      vorname: document.getElementById(`vorname_${i}`).value.trim(),
      nachname: document.getElementById(`nachname_${i}`).value.trim(),
      geburtsdatum: document.getElementById(`geburtsdatum_${i}`).value
    });
  }

  const data = {
    _subject: "üì© Neue Kursanmeldung",
    participant1,
    participants_additional,
    warenkorb_summe: getCartTotal().toFixed(2),
    warenkorb_inhalt: cart.map(i => `${i.name} √ó ${i.qty} = ${(i.price * i.qty).toFixed(2)} ‚Ç¨`).join("; ")
  };

  if (voucherApplied) {
    data.gutschein_code = voucherApplied.code;
    data.gutschein_email = voucherApplied.email;
  }

  try {
    await fetch(FORMSPREE_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
  } catch (err) {
    console.error("‚ùå Fehler beim Senden der Formspree-Anmeldung:", err);
  }
}

// --- PayPal: init & render ---
function showPaypalMissing() {
  document.getElementById("paypal-missing").classList.remove("hidden");
}
function hidePaypalContainer() {
  const cont = document.getElementById("paypal-button-container");
  if (cont) cont.innerHTML = "";
  const pm = document.getElementById("paypal-missing");
  if (pm) pm.classList.add("hidden");
}
function initPayPal() {
  if (isVoucherActive()) {
    hidePaypalContainer();
    return;
  }
  if (typeof paypal === "undefined") {
    showPaypalMissing();
    return;
  }
  const cont = document.getElementById("paypal-button-container");
  cont.innerHTML = "";
  if (!cart || cart.length === 0) {
    cont.innerHTML = "<div class='small muted'>Dein Warenkorb ist leer.</div>";
    return;
  }

  paypal.Buttons({
  createOrder: (data, actions) => {
    return actions.order.create({
      purchase_units: [{
        description: cart.map(i => `${i.name} x${i.qty}`).join("; "),
        amount: { currency_code: "EUR", value: getCartTotal().toFixed(2) }
      }]
    });
  },

  onApprove: async (data, actions) => {
    const details = await actions.order.capture();

    // Formspree-Daten vorbereiten
    const formData = new FormData();
    formData.append("order_id", data.orderID);
    formData.append("payer_name", details.payer?.name?.given_name || "");
    formData.append("cart", cart.map(i => `${i.name} x${i.qty}`).join("; "));
    formData.append("total", getCartTotal().toFixed(2));

    // An Formspree schicken
    try {
      await fetch(FORMSPREE_ENDPOINT, { method: "POST", body: formData });
    } catch (e) {
      console.error("Formspree Fehler:", e);
    }

    // Warenkorb l√∂schen
    localStorage.removeItem("cart");

    // Weiterleiten
    window.location.href = REDIRECT_AFTER_PAYMENT;
  },

  onError: (err) => {
    console.error("PayPal Fehler:", err);
    alert("‚ö†Ô∏è Zahlung aus technischen Gr√ºnden fehlgeschlagen. Bitte kontaktiere uns per Kontaktformular oder Mail");
  }
}).render('#paypal-button-container');
}
// --- Page lifecycle ---
document.addEventListener("DOMContentLoaded", () => {
  initCheckoutUI();
  if (!cartContainsCourse() && !isVoucherActive()) initPayPal();
});
</script>
</body>
</html>
