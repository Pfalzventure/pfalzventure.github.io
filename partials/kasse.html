<!-- gesamte kasse.html (angepasst f√ºr Mollie, PayPal entfernt) -->
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kasse</title>

  <!-- Minimal styles f√ºr √úbersicht ‚Äî passe an dein Theme an -->
  <style>
    body { font-family: system-ui, sans-serif; padding: 1rem; color:#222; background:#f5f5dc; }
    .container { max-width:900px; margin:0 auto; display:grid; grid-template-columns: 1fr 360px; gap:1.5rem; }
    h1 { color: var(--dark-green, #0f5132); margin:0 0 .5rem 0; }
    .card { background:#fff; border:1px solid #eee; padding:1rem; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.03); }
    .muted { color:#666; font-size:0.95rem; }
    .btn { display:inline-block; padding:0.6rem 1rem; border-radius:6px; border:none; background:#0f5132; color:#fff; cursor:pointer; text-decoration:none; }
    .btn:disabled { opacity:0.5; cursor:not-allowed; }
    .cart-list { list-style:none; padding:0; margin:0 0 1rem 0; }
    .cart-list li { padding:0.4rem 0; border-bottom:1px dashed #eee; display:flex; justify-content:space-between; align-items:center; }
    .small { font-size:0.9rem; }
    .success { color:green; }
    .error { color:red; }
    label { display:block; margin-top:0.75rem; font-weight:600; }
    input[type="text"], input[type="email"], input[type="tel"], input[type="date"], input[type="number"], select { width:100%; padding:0.5rem; margin-top:0.25rem; border:1px solid #ddd; border-radius:6px; box-sizing:border-box; }
    .form-actions { margin-top:1rem; display:flex; gap:.5rem; align-items:center; }
    .hidden { display:none !important; }
    .center { text-align:center; }
    .right-aux { margin-top:1rem; }

    /* Infobox */
    .info-box {
      margin-top: 1rem;
      background: #e7f7ee;
      border-left: 4px solid #0f5132;
      padding: 0.75rem 1rem;
      border-radius: 6px;
      color: #0b3b2a;
    }

    /* Sidebar sticky (Option 1) */
    #checkout-right { position:sticky; top:1rem; align-self:start; }

    @media (max-width:900px) { .container { grid-template-columns: 1fr; } #checkout-right { position: static; } }
  </style>

<link rel="stylesheet" href="../style.css">

</head>
<body>

  <button class="btn back-home-btn" onclick="window.location.href='../index.html'">
    Zur√ºck zur Startseite
  </button>

  <main class="container">
    <!-- =============== LINKS: Formular & Checkout-Status =============== -->
    <section class="card" id="checkout-left">
      <h1>Kasse</h1>
      <p class="muted">Bitte √ºberpr√ºfe deine Bestellung, f√ºlle das Formular aus (nicht notwendig bei Kauf von Geschenkgutscheinen) und fahre mit der Zahlung fort.</p>

  <form id="registrationForm" class="hidden">
  <h2 style="color:var(--dark-green); margin-top:1rem;">Teilnehmerdaten / Lieferadresse</h2>

  <!-- Teilnehmer 1 (Vertragspartner) -->
  <div id="participant1" class="participant-block">
    <h3>Teilnehmer 1</h3>

    <input type="text" name="vorname" id="vorname" placeholder="Vorname" required>
    <input type="text" name="nachname" id="nachname" placeholder="Nachname" required>

    <input type="text" name="strasse" id="strasse" placeholder="Stra√üe & Hausnummer" required>
    <input type="text" name="plz_ort" id="plz_ort" placeholder="PLZ & Ort" required>

    <input type="email" name="email" id="teilnehmer_email" placeholder="E-Mail-Adresse" required>
    <input type="tel" name="telefon" id="telefon" placeholder="Telefonnummer (optional)">

  <div id="birthdate-wrapper" style="margin-top:1rem;">
    <label for="geburtsdatum" style="font-weight:bold;">Geburtsdatum</label>
    <input type="date" name="geburtsdatum" id="geburtsdatum">
</div>


    <!-- Hinweis zu Minderj√§hrigen wird extern geregelt -->
  </div>

  <!-- Dropdown Anzahl Teilnehmer (unterhalb des Anmeldeformulars von Teilnehmer 1 wie gew√ºnscht) -->
  <div style="margin-top:1rem;">
    <label for="participantCount" style="font-weight:600;">Anzahl Teilnehmer (inkl. Teilnehmer 1)</label>
    <select id="participantCount" style="margin-left:.5rem;">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>
  </div>

  <!-- Container f√ºr zus√§tzliche Teilnehmerformulare -->
  <div id="additional-participants" style="margin-top:1rem;"></div>

  <h2 style="color:var(--dark-green); margin-top:2rem;">Best√§tigungen</h2>

  <label>
    <input type="checkbox" id="agb" required>
    Ich habe die <a href="../AGB.html">AGB</a> gelesen und akzeptiere sie. Bei Buchung eines Kurses best√§tige ich, dass die Teilnahmebedingungen f√ºr alle angegebenen Teilnehmer gelten.
  </label>

  <!-- Hervorgehobene Infobox unter den Best√§tigungen -->
  <div class="info-box" role="note" aria-live="polite">
    <strong>Wichtige Hinweise:</strong>
    <ul style="margin:0.5rem 0 0 1.1rem; padding:0;">
      <li>Minderj√§hrige d√ºrfen nur in Begleitung eines Erwachsenen teilnehmen, der die Aufsichtspflicht f√ºr sie √ºbernimmt.</li>
      <li>Der Vertrag kommt erst mit Zahlungseingang zustande.</li>
    </ul>
  </div>

  <div id="form-message" class="small" style="margin-top:.5rem;"></div>

  <div class="form-actions">
    <button id="proceedToPayBtn" type="button" class="btn hidden">Weiter zur Zahlung</button>
  </div>
<div id="proceedText" class="small muted hidden" style="margin-top:0.5rem;font-size:0.5rem;">
  *Beim Klick auf den Button werden deine Daten an den Veranstalter weitergeleitet. Mehr Infos findest du in unseren AGB.
</div>
    
</form>
      
     <!-- === Anmeldeformular (bereinigt) === -->
</section>

<!-- =============== RECHTS: Warenkorb, Gutschein (oben Warenkorb, darunter Gutschein) & PayPal =============== -->
    <aside class="card" id="checkout-right">
      <h2>Dein Warenkorb</h2>

      <ul id="cart-items" class="cart-list"></ul>
      <p><strong>Gesamt: <span id="cart-total">0.00</span> ‚Ç¨</strong></p>

      <!-- === Gutscheincode: unter Warenkorb === -->
      <div id="voucher-section" style="margin-top:1rem;">
        <h3>üéüÔ∏è Gutscheincode einl√∂sen</h3>
        <label for="voucherCode">Gutscheincode</label>
        <input type="text" id="voucherCode" placeholder="Code eingeben">

        <label for="customerEmail">Deine E-Mail-Adresse</label>
        <input type="email" id="customerEmail" placeholder="name@example.com">

        <div class="form-actions">
          <button onclick="submitVoucherRequest()" class="btn add-btn">Einl√∂sen</button>
          <span id="voucherMessage" class="small" style="margin-left:.5rem;"></span>
        </div>
      </div>

      <div id="pay-area" style="margin-top:1rem;">
        <!-- Hier wird jetzt der Mollie-Checkout-Button gerendert -->
        <div id="paypal-button-container"></div>

        <!-- Fallback / Info, falls Backend/Payment nicht erreichbar -->
        <div id="paypal-missing" class="hidden small error" style="margin-top:.5rem;">
          Zahlungsdienst zurzeit nicht erreichbar. Bitte versuche es sp√§ter oder kontaktiere uns.
        </div>
      </div>
    </aside>

  </main>

<script>
/*******************************
 * kasse.html ‚Äî Checkout-Logik (angepasst f√ºr Mollie)
 *******************************/

const FORMSPREE_ENDPOINT = "https://formspree.io/f/mldlyqdz";
const REDIRECT_AFTER_PAYMENT = "/danke-bestellung.html";

let cart = JSON.parse(localStorage.getItem("cart") || "[]");
let voucherApplied = null;

// Utilities
function getCartTotal() {
  return cart.reduce((s, i) => s + i.price * i.qty, 0);
}
function cartNeedsForm() {
  return cart.some(i =>
    (i.name || "").includes("Termin:") ||
    (i.name || "").includes("Survival Kit")
  );
}

  function updateBirthdateVisibility() {
    const hasCourse = cartNeedsForm();
    const wrapper = document.getElementById("birthdate-wrapper");
    const input = document.getElementById("geburtsdatum");

    if (!wrapper || !input) return;

    if (hasCourse) {
        wrapper.classList.remove("hidden");
        input.required = true;
    } else {
        wrapper.classList.add("hidden");
        input.required = false;
    }
}

  
// --- Update Cart UI ---
function updateCartDisplay() {
  const list = document.getElementById("cart-items");
  if (!list) return;
  list.innerHTML = "";
  cart.forEach((item) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <div style="flex:1">
        <div>${item.name}</div>
        <div class="small muted">${item.qty} √ó ${item.price.toFixed(2)} ‚Ç¨</div>
      </div>
      <div style="text-align:right">${(item.price * item.qty).toFixed(2)} ‚Ç¨</div>
    `;
    list.appendChild(li);
  });
  const totalEl = document.getElementById("cart-total");
  if (totalEl) totalEl.innerText = getCartTotal().toFixed(2);
  if (!cart || cart.length === 0) {
    const cont = document.getElementById("paypal-button-container");
    if (cont) cont.innerHTML = "<div class='small muted'>Dein Warenkorb ist leer.</div>";
  }
}

// --- Init UI ---
function initCheckoutUI() {
  voucherApplied = null;
  const voucherMsg = document.getElementById("voucherMessage");
  if (voucherMsg) { voucherMsg.textContent = ""; voucherMsg.className = "small"; }

  updateCartDisplay();

  const registrationForm = document.getElementById("registrationForm");
  const hasCourse = cartNeedsForm();

  if (hasCourse) {
    registrationForm.classList.remove("hidden");
  } else {
    registrationForm.classList.add("hidden");
  }

  // **Mollie-Button immer erzeugen**
  initMollie();  // <= hier statt nur in else-Zweig

  // Teilnehmeranzahl
  const countSelect = document.getElementById('participantCount');
  if (countSelect) {
    countSelect.addEventListener('change', renderAdditionalParticipants);
  }

  renderAdditionalParticipants();

  // Wire up proceed button
const proceedBtn = document.getElementById("proceedToPayBtn");
if (proceedBtn) {
  proceedBtn.addEventListener("click", async () => {
    if (!validateRegistrationForm()) return;

    // Formular senden
    await sendRegistrationToFormspree();

    // Mollie-Button aktivieren nur, wenn ein Kurs im Warenkorb liegt
    const payBtn = document.getElementById("payButton");
    if (payBtn) {
      if (cartNeedsForm()) {
        payBtn.disabled = false; // Aktivierung erst nach Klick
      } else {
        payBtn.disabled = false; // Kein Kurs: sofort aktiv
      }
    }

    // Scroll zum Button
    const cont = document.getElementById("paypal-button-container");
    if (cont) cont.scrollIntoView({ behavior: "smooth" });
  });
}


  // Watch basic fields for showing proceed button
  const watchSelectors = [
    "#vorname", "#nachname", "#strasse", "#plz_ort",
    "#teilnehmer_email", "#geburtsdatum",
    "#agb"
  ];
  watchSelectors.forEach(sel => {
    const el = document.querySelector(sel);
    if (!el) return;
    const ev = (el.tagName === "SELECT" || el.type === "checkbox" || el.type === "radio" || el.type === "date") ? "change" : "input";
    el.addEventListener(ev, updateProceedVisibility);
  });

  // initial pr√ºfen
  updateProceedVisibility();
}


  // Mollie-Button direkt erstellen (immer sichtbar, aber ggf. disabled)
initMollie();


// --- Voucher helpers & Anpassung: pr√ºfe Formular wenn Kurs im Warenkorb ---
function isVoucherActive() {
  return voucherApplied && voucherApplied.code;
}
function showVoucherAppliedMessage(text) {
  const msg = document.getElementById("voucherMessage");
  if (!msg) return;
  msg.className = "success";
  msg.textContent = text;
}
function blockPaymentsBecauseVoucher() {
  hidePayContainer();
  document.getElementById("proceedToPayBtn").classList.add("hidden");
}
function unblockPayments() {
  const hasCourse = cartNeedsForm();
  if (hasCourse) {
    document.getElementById("proceedToPayBtn").classList.remove("hidden");
    hidePayContainer();
  } else {
    document.getElementById("proceedToPayBtn").classList.add("hidden");
    initMollie();
  }
}

async function submitVoucherRequest() {
  const code = document.getElementById("voucherCode").value.trim();
  const email = document.getElementById("customerEmail").value.trim();
  const msgEl = document.getElementById("voucherMessage");

  if (!code) {
    if (msgEl) { msgEl.className = "error"; msgEl.textContent = "Bitte Gutscheincode eingeben."; }
    return;
  }
  if (!email || !email.includes("@")) {
    if (msgEl) { msgEl.className = "error"; msgEl.textContent = "Bitte g√ºltige E-Mail-Adresse eingeben."; }
    return;
  }

  // Wenn Kurs im Warenkorb liegt -> Formularsichtbar sein & validiert sein m√ºssen
 if (cartNeedsForm()) {
  const regForm = document.getElementById("registrationForm");
  const formVisible = regForm && !regForm.classList.contains("hidden");
  if (formVisible && !validateRegistrationForm()) {
    if (msgEl) { msgEl.className = "error"; msgEl.textContent = "Bitte f√ºlle zuerst das Anmeldeformular vollst√§ndig aus."; }
    return;
  }
}

  if (msgEl) { msgEl.className = "success"; msgEl.textContent = "Vielen Dank! Dein Gutscheincode wurde eingereicht und wird gepr√ºft."; }

  setTimeout(() => {
    const el = document.getElementById("voucherCode"); if (el) el.value = "";
    const em = document.getElementById("customerEmail"); if (em) em.value = "";
  }, 800);

  try {
    const response = await fetch(FORMSPREE_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        _subject: "ü™ô Neuer Gutschein eingel√∂st",
        code: code,
        kunden_email: email,
        warenkorb_summe: getCartTotal().toFixed(2),
        warenkorb_inhalt: cart.map(i => `${i.name} x${i.qty}`).join("; ")
      }),
    });

    if (!response.ok) throw new Error(`Fehler beim Senden (${response.status})`);

    voucherApplied = { code, email };
    showVoucherAppliedMessage("Vielen Dank! Dein Gutscheincode wurde eingereicht und wird nun gepr√ºft. Du bekommst eine angepasste Rechnung per Mail.");
    blockPaymentsBecauseVoucher();

  } catch (err) {
    console.error("‚ö†Ô∏è Fehler beim Senden an Formspree:", err);
    if (msgEl) { msgEl.className = "error"; msgEl.textContent = "‚ö†Ô∏è Gutschein konnte nicht gesendet werden. Bitte kontaktiere uns per Mail."; }
  }

  setTimeout(() => {
    const msg = document.getElementById("voucherMessage");
    if (msg && !isVoucherActive()) msg.textContent = "";
  }, 8000);
}
window.submitVoucherRequest = submitVoucherRequest;

// --- Dynamisches Erzeugen zus√§tzlicher Teilnehmer (ohne Minderj√§hrig + ohne Copy-Buttons) ---
function renderAdditionalParticipants() {
  const container = document.getElementById('additional-participants');
  const count = parseInt(document.getElementById('participantCount').value, 10) || 1;
  container.innerHTML = "";

  // Wir beginnen bei 2, da Teilnehmer 1 bereits im DOM ist
  for (let i = 2; i <= count; i++) {
    const block = document.createElement('div');
    block.className = 'participant-block';
    block.style.marginTop = '1rem';
    block.id = `participant_block_${i}`;

    block.innerHTML = `
      <h4>Teilnehmer ${i}</h4>
      <input type="text" id="vorname_${i}" placeholder="Vorname" required>
      <input type="text" id="nachname_${i}" placeholder="Nachname" required>
      <label style="font-weight:bold; margin-top:.5rem;">Geburtsdatum</label>
      <input type="date" id="geburtsdatum_${i}" required>
      <div style="margin-top:.5rem;">
        <button type="button" class="btn small" id="remove_${i}">Entfernen</button>
      </div>
    `;
    container.appendChild(block);

    document.getElementById(`remove_${i}`).addEventListener('click', () => {
      // set participantCount to current -1 and re-render
      const sel = document.getElementById('participantCount');
      const newCount = Math.max(1, parseInt(sel.value, 10) - 1);
      sel.value = newCount;
      renderAdditionalParticipants();
      updateProceedVisibility();
    });

    // Watch fields for validation trigger
    ['vorname','nachname','geburtsdatum'].forEach(f => {
      const el = document.getElementById(`${f}_${i}`);
      if (!el) return;
      el.addEventListener('input', updateProceedVisibility);
    });
  }
}

// --- Validation ---
function validateRegistrationForm() {
  const msgEl = document.getElementById("form-message");
  msgEl.textContent = "";

  // Wenn kein Kurs im Warenkorb liegt, Formular muss nicht zwingend ausgef√ºllt sein (aber proceed bleibt hidden)
if (!cartNeedsForm()) {
    return true;
}

  // Teilnehmer 1 checks (contract partner)
  const vorname = document.getElementById("vorname").value.trim();
  const nachname = document.getElementById("nachname").value.trim();
  const strasse = document.getElementById("strasse").value.trim();
  const plzOrt = document.getElementById("plz_ort").value.trim();
  const email = document.getElementById("teilnehmer_email").value.trim();
  const geb = document.getElementById("geburtsdatum").value;
  const agb = document.getElementById("agb").checked;
 

  if (!vorname || !nachname || !strasse || !plzOrt || !email || !geb) {
    msgEl.className = "error";
    msgEl.textContent = "Bitte f√ºlle vor der Zahlung zun√§chst alle Pflichtfelder aus.";
    return false;
  }
  if (!email.includes("@")) {
    msgEl.className = "error";
    msgEl.textContent = "Bitte gib eine g√ºltige E-Mail-Adresse an.";
    return false;
  }
  if (!agb) {
    msgEl.className = "error";
    msgEl.textContent = "Bitte best√§tige noch die AGB Checkbox -> diese gilt f√ºr alle Teilnehmer!";
    return false;
  }

  // Zus√§tzliche Teilnehmer pr√ºfen (ohne Minderj√§hrig-Checks)
  const count = parseInt(document.getElementById('participantCount').value || "1", 10);
  for (let i = 2; i <= count; i++) {
    const v = document.getElementById(`vorname_${i}`)?.value?.trim();
    const n = document.getElementById(`nachname_${i}`)?.value?.trim();
    const g = document.getElementById(`geburtsdatum_${i}`)?.value;

    if (!v || !n || !g) {
      msgEl.className = "error";
      msgEl.textContent = `Bitte f√ºlle alle Pflichtfelder f√ºr die Teilnehmer aus ${i} (Vorname, Nachname, Geburtsdatum).`;
      return false;
    }
  }

  msgEl.className = "success";
  msgEl.textContent = "Formular ist vollst√§ndig. Bitte klicke jetzt auf 'Weiter zur Zahlung'.";
  return true;
}

// Update Proceed Button visibility based on validation
function updateProceedVisibility() {
  const proceedBtn = document.getElementById("proceedToPayBtn");
  const proceedText = document.getElementById("proceedText");
  if (!proceedBtn || !proceedText) return;

  if (cartNeedsForm() && validateRegistrationForm()) {
    proceedBtn.classList.remove("hidden");
    proceedText.classList.remove("hidden"); // Text einblenden
  } else {
    proceedBtn.classList.add("hidden");
    proceedText.classList.add("hidden"); // Text ausblenden
  }
}
  
  // --- Generate email message for Formspree ---
function generateFormspreeMessage(data) {
  const p1 = data.participant1;
  const additional = data.participants_additional || [];

  // Format participants
  let additionalText = "";
  if (additional.length > 0) {
    additionalText += "Weitere Teilnehmer:\n";
    additional.forEach((p, idx) => {
      additionalText += `- Teilnehmer ${idx + 2}: ${p.vorname} ${p.nachname}, Geburtsdatum: ${p.geburtsdatum}\n`;
    });
    additionalText += "\n";
  }

  // Format cart items (monospaced table-like)
  let cartText = "";
  cartText += "Produkt                     Menge   Preis\n";
  cartText += "--------------------------------------------\n";

  data.warenkorb_inhalt.split("; ").forEach(item => {
    const parts = item.split(" = ");
    const left = parts[0].split(" √ó ");
    const name = left[0].padEnd(25, " ");
    const qty = left[1].toString().padEnd(7, " ");
    const price = parts[1];
    cartText += `${name}${qty}${price}\n`;
  });

  // Voucher text
  let voucherPart = "";
  if (data.gutschein_code) {
    voucherPart = `\nEs wurde ein Gutschein eingel√∂st:\nCode: ${data.gutschein_code}\n\n`;
  }

  // Final message
  return `
Hallo ${p1.vorname},

vielen Dank f√ºr deine Buchung bei Pfalzventure!
Wir best√§tigen dir hiermit den erfolgreichen Zahlungseingang und deine Teilnahme am Kurs.

--------------------------------------------
BUCHUNG & TEILNEHMERDATEN
--------------------------------------------

Vertragspartner / Teilnehmer 1:
- ${p1.vorname} ${p1.nachname}
  Geburtsdatum: ${p1.geburtsdatum}
  E-Mail: ${p1.email}
  Telefon: ${p1.telefon}
  Adresse: ${p1.strasse}, ${p1.plz_ort}

${additionalText}--------------------------------------------
BESTELL√úBERSICHT
--------------------------------------------

${cartText}
Gesamtsumme: ${data.warenkorb_summe} ‚Ç¨

${voucherPart}--------------------------------------------
Was solltest du Mitbringen?
--------------------------------------------

F√ºr den Kurs empfehlen wir dir folgende Grundausstattung:

- wetterfeste Kleidung
- feste Schuhe
- Schlafsack oder Decke
- Isomatte (falls vorhanden)

Wenn du noch Fragen hast oder bei etwas unsicher bist, melde dich gerne bei uns.
Auf unserer Kontaktseite findest du verschiedene M√∂glichkeiten, wie du uns erreichen kannst:
${data.link_kontakt}


${voucherPart}--------------------------------------------
Treffpunkt
--------------------------------------------

Wir treffen uns am Kurstermin um 9:30 auf dem Parkplatz der Eckwiesenstra√üe in 67473 Lindenberg. Von dortaus laufen wir geschlossen los.
Auf unserer Kursseite findest du alle weiteren Infos bez√ºglich deinem gebuchten Kurs:
${data.link_kurse}

--------------------------------------------
STORNIERUNG
--------------------------------------------

Eine Stornierung ist bis zu 30 Tagen vor Kursbeginn kostenfrei m√∂glich.
Die vollst√§ndigen AGB findest du hier:
${data.link_agb}

--------------------------------------------

Viele Gr√º√üe,
Robert Prokasky
Pfalzventure
  `.trim();
}

// --- Send registration to Formspree ---
async function sendRegistrationToFormspree() {

  const p1 = {
    vorname: document.getElementById("vorname").value.trim(),
    nachname: document.getElementById("nachname").value.trim(),
    strasse: document.getElementById("strasse").value.trim(),
    plz_ort: document.getElementById("plz_ort").value.trim(),
    email: document.getElementById("teilnehmer_email").value.trim(),
    telefon: document.getElementById("telefon").value.trim(),
    geburtsdatum: document.getElementById("geburtsdatum").value,
    agb: document.getElementById("agb").checked ? "ja" : "nein",
  };

  const participants_additional = [];
  const count = parseInt(document.getElementById("participantCount").value || "1", 10);

  for (let i = 2; i <= count; i++) {
    participants_additional.push({
      vorname: document.getElementById(`vorname_${i}`).value.trim(),
      nachname: document.getElementById(`nachname_${i}`).value.trim(),
      geburtsdatum: document.getElementById(`geburtsdatum_${i}`).value
    });
  }

  const data = {
    participant1: p1,
    participants_additional,
    warenkorb_summe: getCartTotal().toFixed(2),
    warenkorb_inhalt: cart
      .map(i => `${i.name} √ó ${i.qty} = ${(i.price * i.qty).toFixed(2)} ‚Ç¨`)
      .join("; "),
    link_agb: "https://pfalzventure.de/AGB.html",
    link_kontakt: "https://pfalzventure.de/kontakt.html",
    storno_tage: 14
  };

  if (voucherApplied) {
    data.gutschein_code = voucherApplied.code;
  }

  // E-Mail Nachricht erzeugen
  const confirmation_message = generateFormspreeMessage(data);

  // --- Spam-resistenter Payload f√ºr Formspree ---
  const payload = {
    subject: "Neue Kursanmeldung",       // ohne Emoji f√ºr weniger Spam
    email: p1.email,                      // vom Kunden ‚Üí im Formspree Dashboard als reply-to setzen!
    confirmation_message: confirmation_message,

    // --- strukturierte Zusatzfelder (reduziert Spam deutlich) ---
    vorname: p1.vorname,
    nachname: p1.nachname,
    telefon: p1.telefon,
    adresse: `${p1.strasse}, ${p1.plz_ort}`,
    geburtsdatum: p1.geburtsdatum,

    warenkorb_summe: data.warenkorb_summe,
    warenkorb_inhalt: data.warenkorb_inhalt,
    gutschein_code: data.gutschein_code || "",

    // --- zus√§tzliche Metadaten (Spam-Score sinkt!)
    meta_timestamp: new Date().toISOString(),
    meta_source: "pfalzventure_webshop",
    meta_version: "v2_formspree_payload"
  };

  try {
    await fetch(FORMSPREE_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
  } catch (err) {
    console.error("‚ùå Fehler beim Senden der Formspree-Anmeldung:", err);
  }
}

/* -----------------------------
   Payment (Mollie) Integration
   ----------------------------- */

/* Utility: show/hide payment UI */
function showPaymentMissing() {
  const pm = document.getElementById("paypal-missing");
  if (pm) {
    pm.textContent = "Zahlungsdienst zurzeit nicht erreichbar. Bitte versuche es sp√§ter oder kontaktiere uns.";
    pm.classList.remove("hidden");
  }
}
function hidePayContainer() {
  const cont = document.getElementById("paypal-button-container");
  if (cont) cont.innerHTML = "";
  const pm = document.getElementById("paypal-missing");
  if (pm) pm.classList.add("hidden");
}

/* Init Mollie UI: rendert einfachen Button in der vorhandenen Container-DOM */
function initMollie() {
  const cont = document.getElementById("paypal-button-container");
  if (!cont) return;

  // Nur einmal erzeugen
  if (document.getElementById("payButton")) return;

  const btn = document.createElement("button");
  btn.id = "payButton";
  btn.className = "btn";
  btn.textContent = "Jetzt Zahlungspflichtig bestellen";
  btn.disabled = true; // immer initial disabled

  btn.addEventListener("click", createMolliePayment);

  cont.appendChild(btn);
}

/* createMolliePayment: ruft dein Vercel-Backend auf, bekommt checkoutUrl und leitet weiter */
async function createMolliePayment() {
  const btn = document.getElementById("payButton");
  if (btn) btn.disabled = true;

  // letzte clientseitige Pr√ºfung
  if (!cart || cart.length === 0) {
    alert("Dein Warenkorb ist leer.");
    if (btn) btn.disabled = false;
    return;
  }
  if (getCartTotal() <= 0) {
    alert("Gesamtbetrag ung√ºltig.");
    if (btn) btn.disabled = false;
    return;
  }

  try {
 const res = await fetch("https://mollie-backend-one.vercel.app/api/create-payment", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ cart })
    });

    if (!res.ok) {
      const err = await res.json().catch(() => null);
      throw new Error(err?.error || `Fehler beim Erstellen der Zahlung (${res.status})`);
    }

    const data = await res.json();

    if (data.checkoutUrl) {
      // Hinweis: wir l√∂schen den lokalen Warenkorb hier NICHT, da die Zahlung noch nicht best√§tigt wurde.
      // Das L√∂schen sollte nach erfolgreicher Zahlung (z.B. via Webhook / Danke-Seite) erfolgen.
      window.location.href = data.checkoutUrl;
      return;
    } else {
      throw new Error(data.error || "Keine Checkout-URL erhalten");
    }
  } catch (err) {
    console.error("Zahlungsfehler:", err);
    alert("Fehler beim Erstellen der Zahlung. Bitte versuche es sp√§ter oder kontaktiere uns.");
    if (btn) btn.disabled = false;
    // Sichtbare Fehlernachricht optional
    const pm = document.getElementById("paypal-missing");
    if (pm) {
      pm.className = "small error";
      pm.textContent = "Zahlung konnte nicht gestartet werden. Bitte kontaktiere uns.";
      pm.classList.remove("hidden");
    }
  }
}

/* -----------------------------
   Ende Mollie-Integration
   ----------------------------- */

/* Note: die alte PayPal-Logik (initPayPal + onApprove) wurde entfernt.
   Die restliche Formspree- & Registrierungs-Logik bleibt unver√§ndert. */

/* --- Page lifecycle --- */
document.addEventListener("DOMContentLoaded", () => {
  initCheckoutUI();
  const payBtn = document.getElementById("payButton");
 if (payBtn && !cartNeedsForm()) {
  payBtn.disabled = false; // sofort aktiv
}
});

</script>
</body>
</html>
