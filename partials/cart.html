<!-- ============================
     🛍️ Warenkorb-Fenster
     ============================ -->
<div id="cart" class="cart closed">
  <h3 style="margin:0 0 10px 0;">🛒 Dein Warenkorb</h3>

  <ul id="cart-items" class="cart-list" style="list-style:none;padding:0;margin:0 0 10px 0;"></ul>

  <p style="margin:6px 0;">
    <strong>Gesamt: <span id="cart-total">0.00</span> €</strong>
  </p>

  <div class="cart-discount" style="margin-bottom:10px;">
    <label for="voucherCode">🎟️ Gutscheincode:</label><br>
    <input type="text" id="voucherCode" placeholder="Code eingeben" style="width:100%;">

    <label for="customerEmail">📧 Deine E-Mail-Adresse:</label><br>
    <input type="email" id="customerEmail" placeholder="name@example.com" style="width:100%;">

    <button onclick="submitVoucherRequest()" class="btn" style="margin-top:8px;">Gutschein einlösen</button>
    <p id="voucherMessage" style="margin:4px 0 0 0; font-size:0.9em;"></p>
  </div>

  <div id="paypal-button-container" style="margin-bottom:10px;"></div>
  <button onclick="toggleCart()" class="btn" style="align-self:flex-end;">Schließen</button>
</div>

<!-- ============================
     💅 Warenkorb-Style & Animation
     ============================ -->
<style>
#cart {
  position: fixed;
  top: 80px;
  right: 20px;
  width: 340px;
  max-width: 90vw;
  max-height: 80vh;
  background: white;
  border: 1px solid #ccc;
  border-radius: 12px;
  box-shadow: 0 4px 18px rgba(0, 0, 0, 0.25);
  padding: 16px;
  z-index: 1000;
  overflow-y: auto;
  opacity: 0;
  transform: translateY(-10px);
  pointer-events: none;
  transition: opacity 0.25s ease, transform 0.25s ease;
}
#cart.open {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}
</style>

<!-- ============================
     ⚙️ Warenkorb-Logik
     ============================ -->
<script>
let cart = JSON.parse(localStorage.getItem("cart") || "[]");

// ============================
// 🔄 Speicherfunktionen
// ============================
function saveCart() {
  localStorage.setItem("cart", JSON.stringify(cart));
  updateCart();
  initPayPal();
}
function loadCart() {
  cart = JSON.parse(localStorage.getItem("cart") || "[]");
  updateCart();
  initPayPal();
}

// ============================
// 🧾 Artikel hinzufügen
// ============================
function addToCart(name, price, qty = 1) {
  const existing = cart.find(i => i.name === name && i.price === price);
  if (existing) existing.qty += qty;
  else cart.push({ name, price, qty });
  saveCart();
  triggerCartBounce();
}

// ============================
// 📅 Kurs mit Termin hinzufügen
// ============================
function addCourseVoucher(selectId, kursName, kursPreis) {
  const select = document.getElementById(selectId);
  if (!select) return alert("Keine Termine verfügbar.");
  const selected = Array.from(select.selectedOptions).map(o => o.textContent);
  if (selected.length === 0) return alert("Bitte wähle einen Termin aus!");

  selected.forEach(term => {
    const name = `${kursName} – Termin: ${term}`;
    const existing = cart.find(i => i.name === name && i.price === kursPreis);
    if (existing) existing.qty++;
    else cart.push({ name, price: kursPreis, qty: 1 });
  });

  saveCart();
  triggerCartBounce();
}

// ============================
// ➕➖ Mengensteuerung
// ============================
function increaseQty(i) { cart[i].qty++; saveCart(); }
function decreaseQty(i) { if (--cart[i].qty <= 0) cart.splice(i, 1); saveCart(); }

// ============================
// 💰 Summe berechnen
// ============================
function getCartTotal() {
  return cart.reduce((s, i) => s + i.price * i.qty, 0);
}

// ============================
// 💬 Anzeige aktualisieren
// ============================
function updateCart() {
  const countEl = document.getElementById("cart-count");
  if (countEl) countEl.innerText = cart.reduce((s, i) => s + i.qty, 0);

  const list = document.getElementById("cart-items");
  if (!list) return;
  list.innerHTML = "";
  cart.forEach((item, i) => {
    const li = document.createElement("li");
    li.innerHTML = `
      ${item.name} – ${item.price.toFixed(2)} € 
      <div class="cart-controls">
        <button onclick="decreaseQty(${i})">➖</button>
        <span class="cart-qty">${item.qty}</span>
        <button onclick="increaseQty(${i})">➕</button>
      </div>`;
    list.appendChild(li);
  });

  const totalEl = document.getElementById("cart-total");
  if (totalEl) totalEl.innerText = getCartTotal().toFixed(2);
}

// ============================
// 💳 PayPal Integration
// ============================
function initPayPal() {
  if (typeof paypal === "undefined") return;
  const cont = document.getElementById("paypal-button-container");
  if (!cont) return;
  cont.innerHTML = "";
  if (cart.length === 0) return;

  paypal.Buttons({
    createOrder: (d, a) => a.order.create({
      purchase_units: [{
        description: cart.map(i => `${i.name} x${i.qty}`).join("; "),
        amount: { currency_code: "EUR", value: getCartTotal().toFixed(2) }
      }]
    }),
    onApprove: (d, a) => a.order.capture().then(det => {
      alert("Danke, " + (det.payer?.name?.given_name || "") + "!");
      cart = [];
      saveCart();
      toggleCart(false);
    }),
    onError: (err) => {
      console.error("PayPal Fehler:", err);
      alert("⚠️ Zahlung fehlgeschlagen. Bitte erneut versuchen.");
    }
  }).render('#paypal-button-container');
}

// ============================
// 🎟️ Gutschein-Eingabe
// ============================
function submitVoucherRequest() {
  const code = document.getElementById("voucherCode").value.trim();
  const email = document.getElementById("customerEmail").value.trim();
  const msgEl = document.getElementById("voucherMessage");

  if (!code) {
    msgEl.style.color = "red";
    msgEl.textContent = "Bitte Gutscheincode eingeben.";
    return;
  }
  if (!email || !email.includes("@")) {
    msgEl.style.color = "red";
    msgEl.textContent = "Bitte gültige E-Mail-Adresse eingeben.";
    return;
  }

  msgEl.style.color = "green";
  msgEl.textContent = "✅ Dein Gutscheincode wurde registriert. Du erhältst eine angepasste Rechnung per E-Mail.";
  document.getElementById("voucherCode").value = "";
  document.getElementById("customerEmail").value = "";
}

// ============================
// 🪄 Öffnen / Schließen
// ============================
function toggleCart(forceState = null) {
  const el = document.getElementById("cart");
  if (!el) return;
  const isOpen = el.classList.contains("open");
  if (forceState === true || (!isOpen && forceState === null)) {
    el.classList.add("open");
  } else if (forceState === false || (isOpen && forceState === null)) {
    el.classList.remove("open");
  }
}

// Klick außerhalb schließt Warenkorb
document.addEventListener("click", (event) => {
  const cartEl = document.getElementById("cart");
  const toggle = document.getElementById("cart-toggle");
  if (!cartEl || !toggle) return;
  if (!cartEl.contains(event.target) && !toggle.contains(event.target)) {
    toggleCart(false);
  }
});

// ============================
// 🚀 Initialisierung
// ============================
document.addEventListener("DOMContentLoaded", () => {
  toggleCart(false);
  loadCart();
});
</script>
