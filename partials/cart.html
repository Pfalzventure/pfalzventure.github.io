<!-- ============================
     🛒 Zentraler Warenkorb (optimierte Optik)
     ============================ -->
<div id="cart" style="
  display:none;
  position:fixed;
  top:80px;
  right:20px;
  width:340px;
  max-width:90vw;
  max-height:80vh;
  background:white;
  border:1px solid #ccc;
  border-radius:12px;
  box-shadow:0 4px 18px rgba(0,0,0,0.2);
  padding:16px;
  z-index:1000;

  display:flex;
  flex-direction:column;
  overflow:hidden;
">

  <h3 style="margin:0 0 10px 0;">🛒 Dein Warenkorb</h3>

  <!-- 🧾 Artikelbereich -->
  <div id="cart-items-container" style="
    flex:1 1 auto;
    overflow-y:auto;
    border-top:1px solid #ddd;
    border-bottom:1px solid #ddd;
    padding:8px 0;
    margin-bottom:10px;
  ">
    <ul id="cart-items" class="cart-list" style="list-style:none; padding:0; margin:0;"></ul>
  </div>

  <!-- 💰 Gesamtsumme -->
  <p style="margin:6px 0;">
    <strong>Gesamt: <span id="cart-total">0.00</span> €</strong>
  </p>

  <!-- 🎟️ Gutschein + Mail -->
  <div class="cart-discount" style="
    margin-bottom:10px;
    display:flex;
    flex-direction:column;
    gap:6px;
  ">
    <label for="voucherCode">🎟️ Gutscheincode:</label>
    <input type="text" id="voucherCode" placeholder="Code eingeben" style="padding:4px;">

    <label for="customerEmail">📧 Deine E-Mail-Adresse:</label>
    <input type="email" id="customerEmail" placeholder="name@example.com" style="padding:4px;">

    <button onclick="submitVoucherRequest()" class="btn" style="margin-top:6px;">Gutschein einlösen</button>
    <p id="voucherMessage" style="margin:4px 0 0 0; font-size:0.9em;"></p>
  </div>

  <!-- 💳 PayPal -->
  <div id="paypal-button-container" style="margin-bottom:10px;"></div>

  <button onclick="toggleCart()" class="btn" style="align-self:flex-end;">Schließen</button>
</div>

<!-- ============================
     ⚙️ Warenkorb-Logik
     ============================ -->
<script>
let cart = JSON.parse(localStorage.getItem("cart") || "[]");

// ============================
// 🔄 Speicherfunktionen
// ============================
function saveCart() {
  localStorage.setItem("cart", JSON.stringify(cart));
  updateCart();
}

function loadCart() {
  cart = JSON.parse(localStorage.getItem("cart") || "[]");
  updateCart();
}

// ============================
// 🧾 Artikel hinzufügen
// ============================
function addToCart(name, price, qty = 1) {
  const existing = cart.find(i => i.name === name && i.price === price);
  if (existing) existing.qty += qty;
  else cart.push({ name, price, qty });
  saveCart();
  triggerCartBounce();
}

// ============================
// 📅 Kurs mit Termin hinzufügen
// ============================
function addCourseVoucher(selectId, kursName, kursPreis) {
  const select = document.getElementById(selectId);
  if (!select) return alert("Keine Termine verfügbar.");

  const selected = Array.from(select.selectedOptions).map(o => o.textContent);
  if (selected.length === 0) return alert("Bitte wähle einen Termin aus!");

  selected.forEach(term => {
    const name = `${kursName} – Termin: ${term}`;
    const existing = cart.find(i => i.name === name && i.price === kursPreis);
    if (existing) existing.qty++;
    else cart.push({ name, price: kursPreis, qty: 1 });
  });

  saveCart();
  triggerCartBounce();
}

// ============================
// ➕➖ Mengensteuerung
// ============================
function increaseQty(i) { cart[i].qty++; saveCart(); }
function decreaseQty(i) { if (--cart[i].qty <= 0) cart.splice(i, 1); saveCart(); }

// ============================
// 💰 Summe berechnen
// ============================
function getCartTotal() {
  return cart.reduce((s, i) => s + i.price * i.qty, 0);
}

// ============================
// 💬 Anzeige aktualisieren
// ============================
function updateCart() {
  const countEl = document.getElementById("cart-count");
  if (countEl) countEl.innerText = cart.reduce((s, i) => s + i.qty, 0);

  const list = document.getElementById("cart-items");
  if (!list) return;

  list.innerHTML = "";
  cart.forEach((item, i) => {
    const li = document.createElement("li");
    li.innerHTML = `
      ${item.name} – ${item.price.toFixed(2)} €
      <div class="cart-controls">
        <button onclick="decreaseQty(${i})">➖</button>
        <span class="cart-qty">${item.qty}</span>
        <button onclick="increaseQty(${i})">➕</button>
      </div>`;
    list.appendChild(li);
  });

  const totalEl = document.getElementById("cart-total");
  if (totalEl) totalEl.innerText = getCartTotal().toFixed(2);
}

// ============================
// 🪄 Anzeige & Animation
// ============================
function toggleCart() {
  const el = document.getElementById("cart");
  if (!el) return;
  el.style.display = (el.style.display === "none" || el.style.display === "") ? "block" : "none";
}

// Schließt Warenkorb bei Klick außerhalb
document.addEventListener("click", (e) => {
  const cartEl = document.getElementById("cart");
  if (!cartEl || cartEl.style.display === "none") return;
  if (!cartEl.contains(e.target) && !e.target.closest(".cart-btn")) {
    cartEl.style.display = "none";
  }
});

function triggerCartBounce() {
  const btn = document.querySelector(".cart-btn");
  if (!btn) return;
  btn.classList.remove("added");
  void btn.offsetWidth;
  btn.classList.add("added");
}

// ============================
// 🎟️ Gutschein-Eingabe & Versandinfo
// ============================
function submitVoucherRequest() {
  const code = document.getElementById("voucherCode").value.trim();
  const email = document.getElementById("customerEmail").value.trim();
  const msgEl = document.getElementById("voucherMessage");

  if (!code) {
    msgEl.style.color = "red";
    msgEl.textContent = "Bitte Gutscheincode eingeben.";
    return;
  }
  if (!email || !email.includes("@")) {
    msgEl.style.color = "red";
    msgEl.textContent = "Bitte gültige E-Mail-Adresse eingeben.";
    return;
  }

  // Hinweistext (kein echter Code-Check)
  msgEl.style.color = "green";
  msgEl.textContent = "✅ Dein Gutscheincode wurde registriert. Du erhältst eine angepasste Rechnung per E-Mail.";
  document.getElementById("voucherCode").value = "";
  document.getElementById("customerEmail").value = "";
}

// ============================
// 💳 PayPal Integration
// ============================
function initPayPal() {
  if (typeof paypal === "undefined") return;
  const cont = document.getElementById("paypal-button-container");
  if (!cont) return;

  cont.innerHTML = "";
  paypal.Buttons({
    createOrder: (d, a) => a.order.create({
      purchase_units: [{
        description: cart.map(i => `${i.name} x${i.qty}`).join("; "),
        amount: { currency_code: "EUR", value: getCartTotal().toFixed(2) }
      }]
    }),
    onApprove: (d, a) => a.order.capture().then(det => {
      alert("Danke, " + (det.payer?.name?.given_name || "") + "!");
      cart = [];
      saveCart();
      toggleCart();
    }),
    onError: (err) => {
      console.error("PayPal Fehler:", err);
      alert("⚠️ Zahlung fehlgeschlagen. Bitte erneut versuchen.");
    }
  }).render('#paypal-button-container');
}

// ============================
// 🚀 Start
// ============================
loadCart();
initPayPal();
</script>
