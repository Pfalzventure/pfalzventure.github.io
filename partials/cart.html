<!-- ============================
     ğŸ›’ Warenkorb Popup
     ============================ -->
<div id="cart" style="display:none; position:fixed; top:80px; right:20px; background:white; border:1px solid #ccc; padding:20px; max-width:340px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1000;">
  <h3>ğŸ›’ Dein Warenkorb</h3>
  <ul id="cart-items" class="cart-list"></ul>
  <p><strong>Gesamt: <span id="cart-total">0.00</span> â‚¬</strong></p>

  <!-- ğŸŸï¸ Gutschein-Eingabe -->
  <div class="cart-discount">
    <label for="voucherCode">ğŸŸï¸ Gutschein einlÃ¶sen:</label><br>
    <input type="text" id="voucherCode" placeholder="Code eingeben" />
    <button onclick="applyVoucher()">EinlÃ¶sen</button>
    <p id="voucherMessage"></p>
  </div>

  <!-- ğŸ“§ Formular fÃ¼r Kunden-Mail -->
  <div id="voucherForm" style="display:none;">
    <h4>ğŸ“© E-Mail fÃ¼r Rechnung:</h4>
    <form id="notifyForm">
      <input type="email" id="userEmail" name="email" placeholder="deine@email.de" required />
      <input type="hidden" id="usedVoucher" name="voucher" />
      <button type="submit" class="btn">Absenden</button>
    </form>
    <p id="notifyMessage"></p>
  </div>

  <!-- PayPal -->
  <div id="paypal-button-container"></div>

  <button onclick="toggleCart()" class="btn">SchlieÃŸen</button>
</div>

<!-- ============================
     âš™ï¸ Script komplett integriert
     ============================ -->
<script>
// ============================
// ğŸ›’ Warenkorb-Logik
// ============================

let cart = [];
let eingelÃ¶sterGutschein = null;

function addToCart(name, price, qty = 1) {
  const existing = cart.find(item => item.name === name);
  if (existing) existing.qty += qty;
  else cart.push({ name, price, qty });
  saveCart();
}

function saveCart() {
  localStorage.setItem("cart", JSON.stringify(cart));
  if (eingelÃ¶sterGutschein)
    localStorage.setItem("voucher", JSON.stringify(eingelÃ¶sterGutschein));
  updateCart();
}

function loadCart() {
  // âœ… Gutschein beim Laden der Seite immer zurÃ¼cksetzen
  console.log("ğŸ”„ Gutschein wird beim Laden entfernt");
  localStorage.removeItem("voucher");
  eingelÃ¶sterGutschein = null;

  // ğŸ›’ Warenkorb laden
  const stored = localStorage.getItem("cart");
  if (stored) cart = JSON.parse(stored);
  updateCart();
}

function getCartTotal() {
  let sum = cart.reduce((total, item) => total + item.price * item.qty, 0);
  if (eingelÃ¶sterGutschein) sum -= eingelÃ¶sterGutschein.wert;
  if (sum < 0) sum = 0;
  return sum;
}

function updateCart() {
  const countEl = document.getElementById("cart-count");
  if (countEl) countEl.innerText = cart.reduce((sum, i) => sum + i.qty, 0);

  const list = document.getElementById("cart-items");
  if (!list) return;

  list.innerHTML = "";
  cart.forEach(item => {
    const li = document.createElement("li");
    li.innerText = `${item.name} â€“ ${item.price.toFixed(2)} â‚¬ x ${item.qty}`;
    list.appendChild(li);
  });

  const totalEl = document.getElementById("cart-total");
  if (totalEl) totalEl.innerText = getCartTotal().toFixed(2);
}

function toggleCart() {
  const cartDiv = document.getElementById("cart");
  if (!cartDiv) return;
  cartDiv.style.display =
    (cartDiv.style.display === "none" || cartDiv.style.display === "")
      ? "block"
      : "none";
}

// ============================
// ğŸŸï¸ Gutschein
// ============================

function applyVoucher() {
  const code = document.getElementById("voucherCode").value.trim();
  if (!code) return;

  if (typeof checkVoucher === "function") {
    const result = checkVoucher(code);
    const msg = document.getElementById("voucherMessage");

    if (result.valid) {
      eingelÃ¶sterGutschein = { code, wert: result.amount };
      msg.textContent = `âœ… Gutschein "${code}" eingelÃ¶st: -${result.amount} â‚¬`;
      saveCart();
    } else {
      eingelÃ¶sterGutschein = null;
      msg.textContent = "âŒ UngÃ¼ltiger Gutschein-Code!";
      saveCart();
    }
  } else {
    console.error("âš ï¸ gutscheine.js nicht geladen!");
  }
}

// ============================
// ğŸ’³ PayPal Integration
// ============================

function initPayPal(retry = 0) {
  if (typeof paypal === "undefined") {
    if (retry < 10) {
      console.warn("âŒ› PayPal SDK noch nicht bereit, versuche erneut...");
      setTimeout(() => initPayPal(retry + 1), 500);
      return;
    } else {
      console.error("âŒ PayPal SDK konnte nicht geladen werden!");
      return;
    }
  }

  paypal.Buttons({
    createOrder: function (data, actions) {
      console.log("ğŸ’¶ PayPal-Bestellung wird erstellt...");
      return actions.order.create({
        purchase_units: [{
          description: cart.map(item => `${item.name} x${item.qty}`).join("; "),
          amount: { currency_code: "EUR", value: getCartTotal().toFixed(2) }
        }]
      });
    },
    onApprove: function (data, actions) {
      return actions.order.capture().then(function (details) {
        console.log("âœ… Zahlung erfolgreich:", details);
        alert(`Danke, ${details.payer.name.given_name}! Deine Buchung war erfolgreich.`);

        // ğŸ§¹ Nach erfolgreicher Zahlung alles leeren
        cart = [];
        eingelÃ¶sterGutschein = null;
        localStorage.removeItem("cart");
        localStorage.removeItem("voucher");
        updateCart();
        toggleCart();
      });
    },
    onError: function (err) {
      console.error("âŒ PayPal-Fehler:", err);
      alert("âš ï¸ Zahlung fehlgeschlagen. Bitte versuche es erneut.");
    }
  }).render('#paypal-button-container');
}

// ============================
// ğŸš€ Start
// ============================

document.addEventListener("DOMContentLoaded", () => {
  loadCart();
  initPayPal();
});
</script>

<!-- Gutschein Logik -->
<script src="../gutscheine.js"></script>
