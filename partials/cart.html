<!-- ============================ ğŸ›ï¸ Warenkorb-Fenster ============================ -->
<div id="cart" class="closed">
  <h3>ğŸ›’ Dein Warenkorb</h3>
  <ul id="cart-items" class="cart-list"></ul>
  <p><strong>Gesamt: <span id="cart-total">0.00</span> â‚¬</strong></p>

  <div class="cart-discount">
    <label for="voucherCode">ğŸŸï¸ Gutscheincode:</label>
    <input type="text" id="voucherCode" placeholder="Code eingeben">
<p><br>
    <label for="customerEmail">ğŸ“§ Deine E-Mail-Adresse:</label>
    <input type="email" id="customerEmail" placeholder="name@example.com">

    <button onclick="submitVoucherRequest()" class="btn">Gutschein einlÃ¶sen</button>
    <p id="voucherMessage"></p>
  </div>

  <!-- ğŸ’³ PayPal Buttons -->
  <div id="paypal-button-container"></div>
  <button onclick="toggleCart()" class="btn close-btn">SchlieÃŸen</button>
</div>

<!-- ============================ âš™ï¸ Warenkorb-Logik ============================ -->
<script>
  let cart = JSON.parse(localStorage.getItem("cart") || "[]");

  // ============================
  // ğŸ”„ Speicherfunktionen
  // ============================
  function saveCart() {
    localStorage.setItem("cart", JSON.stringify(cart));
    updateCart();
    initPayPal();
  }

  function loadCart() {
    cart = JSON.parse(localStorage.getItem("cart") || "[]");
    updateCart();
    initPayPal();
  }

  // ============================
  // ğŸ§¾ Artikel hinzufÃ¼gen
  // ============================
  function addToCart(name, price, qty = 1) {
    const existing = cart.find(i => i.name === name && i.price === price);
    if (existing) existing.qty += qty;
    else cart.push({ name, price, qty });
    saveCart();
    triggerCartBounce();
  }

  function triggerCartBounce() {
  const tryBounce = () => {
    const cartIcon = document.getElementById("cart-toggle");
    if (!cartIcon) {
      setTimeout(tryBounce, 100);
      return;
    }
    cartIcon.classList.add("bounce");
    setTimeout(() => cartIcon.classList.remove("bounce"), 600);
  };
  tryBounce();
}



  // ============================
  // ğŸ“… Kurs mit Termin hinzufÃ¼gen
  // ============================
  function addCourseVoucher(selectId, kursName, kursPreis) {
    const select = document.getElementById(selectId);
    if (!select) return alert("Keine Termine verfÃ¼gbar.");

    const selected = Array.from(select.selectedOptions).map(o => o.textContent);
    if (selected.length === 0) return alert("Bitte wÃ¤hle einen Termin aus!");

    selected.forEach(term => {
      const name = `${kursName} â€“ Termin: ${term}`;
      const existing = cart.find(i => i.name === name && i.price === kursPreis);
      if (existing) existing.qty++;
      else cart.push({ name, price: kursPreis, qty: 1 });
    });

    saveCart();
    triggerCartBounce();
  }

  // ============================
  // â•â– Mengensteuerung
  // ============================
  function increaseQty(i) {
    cart[i].qty++;
    saveCart();
  }

  function decreaseQty(i) {
    if (--cart[i].qty <= 0) cart.splice(i, 1);
    saveCart();
  }

  // ============================
  // ğŸ’° Summe berechnen
  // ============================
  function getCartTotal() {
    return cart.reduce((s, i) => s + i.price * i.qty, 0);
  }

  // ============================
  // ğŸ’¬ Anzeige aktualisieren
  // ============================
  function updateCart() {
    const countEl = document.getElementById("cart-count");
    if (countEl) countEl.innerText = cart.reduce((s, i) => s + i.qty, 0);

    const list = document.getElementById("cart-items");
    if (!list) return;
    list.innerHTML = "";

    cart.forEach((item, i) => {
      const li = document.createElement("li");
      li.innerHTML = `
        ${item.name} â€“ ${item.price.toFixed(2)} â‚¬
        <div class="cart-controls">
          <button onclick="decreaseQty(${i})">â–</button>
          <span class="cart-qty">${item.qty}</span>
          <button onclick="increaseQty(${i})">â•</button>
        </div>`;
      list.appendChild(li);
    });

    const totalEl = document.getElementById("cart-total");
    if (totalEl) totalEl.innerText = getCartTotal().toFixed(2);
  }

  // ============================
  // ğŸ’³ PayPal Integration
  // ============================
  function initPayPal() {
    if (typeof paypal === "undefined") return;

    const cont = document.getElementById("paypal-button-container");
    if (!cont) return;
    cont.innerHTML = "";
    if (cart.length === 0) return;

    paypal.Buttons({
      createOrder: (d, a) => a.order.create({
        purchase_units: [{
          description: cart.map(i => `${i.name} x${i.qty}`).join("; "),
          amount: {
            currency_code: "EUR",
            value: getCartTotal().toFixed(2)
          }
        }]
      }),
      onApprove: (d, a) => a.order.capture().then(det => {
        alert("Danke, " + (det.payer?.name?.given_name || "") + "!");
        cart = [];
        saveCart();
        closeCart();
      }),
      onError: (err) => {
        console.error("PayPal Fehler:", err);
        alert("âš ï¸ Zahlung fehlgeschlagen. Bitte erneut versuchen.");
      }
    }).render('#paypal-button-container');
  }

// ============================
// ğŸŸï¸ Gutschein-Eingabe + E-Mail via Formspree (stabil + Feedback)
// ============================
async function submitVoucherRequest() {
  const code = document.getElementById("voucherCode").value.trim();
  const email = document.getElementById("customerEmail").value.trim();
  const msgEl = document.getElementById("voucherMessage");

  // Eingaben prÃ¼fen
  if (!code) {
    msgEl.style.color = "red";
    msgEl.textContent = "Bitte Gutscheincode eingeben.";
    return;
  }

  if (!email || !email.includes("@")) {
    msgEl.style.color = "red";
    msgEl.textContent = "Bitte gÃ¼ltige E-Mail-Adresse eingeben.";
    return;
  }

  // âœ… Sofortige visuelle BestÃ¤tigung (bleibt sichtbar)
  msgEl.style.color = "green";
  msgEl.textContent =
    "âœ… Dein Gutscheincode wird geprÃ¼ft. Du erhÃ¤ltst in kÃ¼rze eine angepasste Rechnung per E-Mail.";

  // Felder erst nach kurzer Zeit leeren, damit Text stehen bleibt
  setTimeout(() => {
    document.getElementById("voucherCode").value = "";
    document.getElementById("customerEmail").value = "";
  }, 1000);

  // ğŸ“§ E-Mail an dich via Formspree senden
  try {
    const response = await fetch("https://formspree.io/f/mldlyqdz", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        _subject: "ğŸª™ Neuer Gutschein eingelÃ¶st",
        code: code,
        kunden_email: email,
        warenkorb_summe: getCartTotal().toFixed(2),
        warenkorb_inhalt: cart.map(i => `${i.name} x${i.qty}`).join("; ")
      }),
    });

    if (!response.ok) {
      throw new Error(`Fehler beim Senden (${response.status})`);
    }

    console.log("âœ… Gutschein-Mail erfolgreich an Formspree gesendet.");
  } catch (err) {
    console.error("âš ï¸ Fehler beim Senden an Formspree:", err);
    msgEl.style.color = "red";
    msgEl.textContent =
      "âš ï¸ Gutschein konnte nicht gesendet werden. Bitte spÃ¤ter erneut versuchen.";
  }

  // Info nach 8 Sekunden wieder ausblenden (optional)
  setTimeout(() => {
    msgEl.textContent = "";
  }, 8000);
}


  // ============================
  // ğŸª„ Ã–ffnen / SchlieÃŸen
  // ============================
  function toggleCart() {
    const el = document.getElementById("cart");
    if (!el) return;
    el.classList.toggle("open");
  }

  function closeCart() {
    const el = document.getElementById("cart");
    if (el) el.classList.remove("open");
  }

// ============================
// ğŸ–±ï¸ Klick auÃŸerhalb schlieÃŸt Warenkorb (robuste Variante)
// ============================

// Erst den Warenkorb laden
loadCart();

// Dann nach kurzer Zeit den Click-Listener aktivieren
setTimeout(() => {
  document.addEventListener("click", function (event) {
    const cart = document.getElementById("cart");
    const toggle = document.getElementById("cart-toggle");
    if (!cart || !toggle) return;
    if (!cart.contains(event.target) && !toggle.contains(event.target)) {
      closeCart();
    }
  });
}, 300);

</script>
